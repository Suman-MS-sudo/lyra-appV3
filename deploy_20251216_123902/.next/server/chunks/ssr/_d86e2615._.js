module.exports=[37936,(a,b,c)=>{"use strict";Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"registerServerReference",{enumerable:!0,get:function(){return d.registerServerReference}});let d=a.r(11857)},13095,(a,b,c)=>{"use strict";function d(a){for(let b=0;b<a.length;b++){let c=a[b];if("function"!=typeof c)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof c}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(c,"__esModule",{value:!0}),Object.defineProperty(c,"ensureServerEntryExports",{enumerable:!0,get:function(){return d}})},79795,a=>{"use strict";var b=a.i(37936),c=a.i(16349),d=a.i(51100),e=a.i(13095);let f=(0,d.createClient)("https://fjghhrubobqwplvokszz.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function g(a){let b=await (0,c.createClient)(),{data:{user:d}}=await b.auth.getUser();if(!d)throw Error("Unauthorized");let{data:e}=await f.from("profiles").select("role").eq("id",d.id).single();if(e?.role!=="admin")throw Error("Only admins can generate invoices");let{organizationId:g,periodStart:h,periodEnd:i}=a,{data:j}=await f.from("organization_invoices").select("id").eq("organization_id",g).eq("period_start",h).eq("period_end",i).single();if(j)throw Error("Invoice already exists for this period");let{data:k,error:l}=await f.rpc("calculate_invoice_amounts",{p_organization_id:g,p_period_start:h,p_period_end:i});if(l)throw l;let m=k?.[0]?.total_amount_paisa||0,n=k?.[0]?.total_transactions||0,{data:o}=await f.rpc("generate_invoice_number"),{data:p,error:q}=await f.from("organization_invoices").insert({organization_id:g,invoice_number:o,period_start:h,period_end:i,total_coin_transactions:n,total_amount_paisa:m,amount_paid_paisa:0,amount_due_paisa:m,status:m>0?"pending":"draft"}).select().single();if(q)throw q;return{success:!0,invoice:p}}async function h(){let a=await (0,c.createClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)throw Error("Unauthorized");let{data:d}=await f.from("profiles").select("role").eq("id",b.id).single();if(d?.role!=="admin")throw Error("Only admins can generate invoices");let{data:e}=await f.from("organizations").select("id, name");if(!e)return{success:!1,message:"No organizations found"};let h=new Date,i=new Date(h.getFullYear(),h.getMonth()-1,1).toISOString(),j=new Date(h.getFullYear(),h.getMonth(),1).toISOString(),k=[];for(let a of e)try{let b=await g({organizationId:a.id,periodStart:i,periodEnd:j});k.push({organizationId:a.id,name:a.name,success:!0,invoice:b.invoice})}catch(b){k.push({organizationId:a.id,name:a.name,success:!1,error:b.message})}return{success:!0,results:k}}async function i(b){let d,e=await (0,c.createClient)(),{data:{user:g}}=await e.auth.getUser();if(!g)throw Error("Unauthorized");let{data:h}=await f.from("profiles").select("role").eq("id",g.id).single();if(h?.role!=="admin")throw Error("Only admins can send invoice emails");let{invoiceId:i}=b,{data:j,error:k}=await f.from("organization_invoices").select(`
      *,
      organizations (
        id,
        name,
        contact_email
      )
    `).eq("id",i).single();if(k||!j)throw Error("Invoice not found");if(!j.organizations.contact_email)throw Error("Organization does not have a contact email");let{sendEmail:l,generateInvoiceEmailHTML:m}=await a.A(74019),n="https://lyra-app.co.in",o=`${n}/admin/billing/${j.id}`,p=`${n}/admin/billing/${j.id}/pay`,q=a=>new Date(a).toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"}),r=new Date(j.created_at);r.setDate(r.getDate()+30);let s=m({invoiceNumber:j.invoice_number,organizationName:j.organizations.name,totalAmount:(d=j.total_amount_paisa,`â‚¹${(d/100).toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}`),dueDate:"paid"===j.status&&j.paid_at?`Paid on ${q(j.paid_at)}`:q(r.toISOString()),invoiceUrl:o,paymentUrl:p,totalAmountPaisa:j.total_amount_paisa}),t=0===j.total_amount_paisa?`Monthly Statement ${j.invoice_number} - No Payment Required`:`Invoice ${j.invoice_number} from Lyra Enterprises`,u=await l({to:j.organizations.contact_email,subject:t,html:s});if(!u.success)throw Error(`Failed to send email: ${u.error}`);return await f.from("organization_invoices").update({email_sent:!0,email_sent_at:new Date().toISOString(),reminder_count:(j.reminder_count||0)+1,last_reminder_sent_at:new Date().toISOString()}).eq("id",i),{success:!0,invoice:j,message:`Email sent to ${j.organizations.contact_email}`}}async function j(a){let b=await (0,c.createClient)(),{data:{user:d}}=await b.auth.getUser();if(!d)throw Error("Unauthorized");let{data:e}=await f.from("profiles").select("role").eq("id",d.id).single();if(e?.role!=="admin")throw Error("Only admins can record payments");let{invoiceId:g,amountPaisa:h,notes:i}=a,{data:j,error:k}=await f.from("organization_invoices").select("*, organizations(id)").eq("id",g).single();if(k||!j)throw Error("Invoice not found");let{data:l,error:m}=await f.from("organization_payments").insert({invoice_id:g,organization_id:j.organizations.id,amount_paisa:h,payment_method:"manual",status:"success",notes:i||"Manual payment recorded by admin",payment_date:new Date().toISOString()}).select().single();if(m)throw m;return{success:!0,payment:l}}async function k(){let a=await (0,c.createClient)(),{data:{user:b}}=await a.auth.getUser();if(!b)throw Error("Unauthorized");let{data:d}=await f.from("profiles").select("role").eq("id",b.id).single();if(d?.role!=="admin")throw Error("Unauthorized");let{data:e,error:g}=await f.from("organization_invoices").select(`
      *,
      organizations (
        id,
        name,
        email
      )
    `).order("created_at",{ascending:!1});if(g)throw g;return{success:!0,invoices:e}}async function l(a){let b=await (0,c.createClient)(),{data:{user:d}}=await b.auth.getUser();if(!d)throw Error("Unauthorized");let{data:e,error:g}=await f.from("organization_invoices").select(`
      *,
      organizations (
        id,
        name,
        email
      ),
      organization_payments (
        id,
        amount_paisa,
        payment_method,
        status,
        payment_date,
        razorpay_payment_id,
        notes
      )
    `).eq("id",a).single();if(g)throw g;return{success:!0,invoice:e}}async function m(b){let d=await (0,c.createClient)(),{data:{user:e}}=await d.auth.getUser();if(!e)throw Error("Unauthorized");let{data:g}=await f.from("profiles").select("role").eq("id",e.id).single();if(g?.role!=="admin")throw Error("Only admins can delete invoices");let{error:h}=await f.from("organization_invoices").delete().eq("id",b);if(h)throw h;let{revalidatePath:i}=await a.A(6728);return i("/admin/billing"),{success:!0,message:"Invoice deleted successfully"}}(0,e.ensureServerEntryExports)([g,h,i,j,k,l,m]),(0,b.registerServerReference)(g,"402c86a10fb53906974e21fe54f7edb38dbad0fcfd",null),(0,b.registerServerReference)(h,"00fd2ddc5f28a9bffb78a1b615c92f26d0222f7fd2",null),(0,b.registerServerReference)(i,"408f34c2d80205b89a0f7b77c61073b36c29f4f96b",null),(0,b.registerServerReference)(j,"4030285a2c3f1443a5a4c8c58c4e1bb7b61a63febb",null),(0,b.registerServerReference)(k,"00d7c0cbdbf5b6ff060fb37d087e719bd70fe344fc",null),(0,b.registerServerReference)(l,"40f70f9715baeed374c151128955b804b23ff016b5",null),(0,b.registerServerReference)(m,"40a7f73406654a2374577af0091523566d6b043190",null),a.s(["deleteInvoice",()=>m,"generateMonthlyInvoices",()=>h,"recordManualPayment",()=>j,"sendInvoiceEmail",()=>i])},16908,a=>{"use strict";var b=a.i(79795);a.s([],55653),a.i(55653),a.s(["00fd2ddc5f28a9bffb78a1b615c92f26d0222f7fd2",()=>b.generateMonthlyInvoices,"4030285a2c3f1443a5a4c8c58c4e1bb7b61a63febb",()=>b.recordManualPayment,"408f34c2d80205b89a0f7b77c61073b36c29f4f96b",()=>b.sendInvoiceEmail,"40a7f73406654a2374577af0091523566d6b043190",()=>b.deleteInvoice],16908)},74019,a=>{a.v(b=>Promise.all(["server/chunks/ssr/[root-of-the-server]__57a270f7._.js","server/chunks/ssr/_53be44bd._.js"].map(b=>a.l(b))).then(()=>b(28725)))},6728,a=>{a.v(b=>Promise.all(["server/chunks/ssr/node_modules_next_0f85809d._.js"].map(b=>a.l(b))).then(()=>b(18558)))}];

//# sourceMappingURL=_d86e2615._.js.map