{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///E:/lyra-app-v3/src/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr';\r\nimport { cookies } from 'next/headers';\r\n\r\nexport async function createClient() {\r\n  const cookieStore = await cookies();\r\n\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        getAll() {\r\n          return cookieStore.getAll();\r\n        },\r\n        setAll(cookiesToSet) {\r\n          try {\r\n            cookiesToSet.forEach(({ name, value, options }) =>\r\n              cookieStore.set(name, value, options)\r\n            );\r\n          } catch {\r\n            // Server Component - cookies().set() will fail\r\n          }\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAAkB,sUAGvB;QACE,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;gBAEjC,EAAE,OAAM;gBACN,+CAA+C;gBACjD;YACF;QACF;IACF;AAEJ"}},
    {"offset": {"line": 160, "column": 0}, "map": {"version":3,"sources":["file:///E:/lyra-app-v3/src/app/api/billing/create-order/route.ts"],"sourcesContent":["import { createClient } from '@/lib/supabase/server';\r\nimport { createClient as createServiceClient } from '@supabase/supabase-js';\r\nimport Razorpay from 'razorpay';\r\nimport { NextRequest, NextResponse } from 'next/server';\r\n\r\nconst razorpay = new Razorpay({\r\n  key_id: process.env.RAZORPAY_KEY_ID!,\r\n  key_secret: process.env.RAZORPAY_KEY_SECRET!,\r\n});\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const supabase = await createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n    \r\n    if (!user) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    const { invoiceId } = await request.json();\r\n\r\n    const serviceSupabase = createServiceClient(\r\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n      process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n    );\r\n\r\n    // Get invoice details\r\n    const { data: invoice, error } = await serviceSupabase\r\n      .from('organization_invoices')\r\n      .select('*, organizations(name, contact_email)')\r\n      .eq('id', invoiceId)\r\n      .single();\r\n\r\n    if (error || !invoice) {\r\n      return NextResponse.json({ error: 'Invoice not found' }, { status: 404 });\r\n    }\r\n\r\n    if (invoice.status === 'paid') {\r\n      return NextResponse.json({ error: 'Invoice already paid' }, { status: 400 });\r\n    }\r\n\r\n    if (invoice.amount_due_paisa <= 0) {\r\n      return NextResponse.json({ error: 'No amount due' }, { status: 400 });\r\n    }\r\n\r\n    // Check if order already exists and is still valid\r\n    if (invoice.razorpay_order_id) {\r\n      try {\r\n        const existingOrder = await razorpay.orders.fetch(invoice.razorpay_order_id);\r\n        if (existingOrder.status !== 'paid') {\r\n          // Order exists and not expired, reuse it\r\n          return NextResponse.json({\r\n            orderId: existingOrder.id,\r\n            amount: existingOrder.amount,\r\n            currency: existingOrder.currency,\r\n            organizationName: invoice.organizations.name,\r\n            invoiceNumber: invoice.invoice_number,\r\n          });\r\n        }\r\n      } catch (err) {\r\n        // Order doesn't exist or expired, create new one\r\n      }\r\n    }\r\n\r\n    // Create Razorpay order with 30-day expiry\r\n    const expiryTime = Math.floor(Date.now() / 1000) + (30 * 24 * 60 * 60); // 30 days in seconds\r\n    \r\n    const order = await razorpay.orders.create({\r\n      amount: invoice.amount_due_paisa, // Amount in paisa\r\n      currency: 'INR',\r\n      receipt: invoice.invoice_number,\r\n      notes: {\r\n        invoice_id: invoice.id,\r\n        organization_id: invoice.organization_id,\r\n        organization_name: invoice.organizations.name,\r\n        invoice_number: invoice.invoice_number,\r\n      },\r\n      payment_capture: 1, // Auto capture payment\r\n    });\r\n\r\n    // Update invoice with Razorpay order ID\r\n    await serviceSupabase\r\n      .from('organization_invoices')\r\n      .update({ \r\n        razorpay_order_id: order.id,\r\n        updated_at: new Date().toISOString()\r\n      })\r\n      .eq('id', invoiceId);\r\n\r\n    return NextResponse.json({\r\n      orderId: order.id,\r\n      amount: order.amount,\r\n      currency: order.currency,\r\n      organizationName: invoice.organizations.name,\r\n      invoiceNumber: invoice.invoice_number,\r\n      keyId: process.env.NEXT_PUBLIC_RAZORPAY_KEY_ID,\r\n    });\r\n  } catch (error: any) {\r\n    console.error('Error creating order:', error);\r\n    return NextResponse.json(\r\n      { error: error.message || 'Failed to create order' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}