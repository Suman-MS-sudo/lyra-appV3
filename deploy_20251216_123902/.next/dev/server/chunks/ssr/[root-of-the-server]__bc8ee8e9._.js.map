{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///E:/lyra-app-v3/src/app/actions/organization-billing.ts"],"sourcesContent":["'use server';\r\n\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { createClient as createServiceClient } from '@supabase/supabase-js';\r\n\r\nconst serviceSupabase = createServiceClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n);\r\n\r\ninterface GenerateInvoiceParams {\r\n  organizationId: string;\r\n  periodStart: string;\r\n  periodEnd: string;\r\n}\r\n\r\ninterface SendInvoiceEmailParams {\r\n  invoiceId: string;\r\n}\r\n\r\ninterface RecordPaymentParams {\r\n  invoiceId: string;\r\n  amountPaisa: number;\r\n  razorpayOrderId?: string;\r\n  razorpayPaymentId?: string;\r\n  razorpaySignature?: string;\r\n  notes?: string;\r\n}\r\n\r\n/**\r\n * Generate invoice for an organization for a specific period\r\n */\r\nexport async function generateInvoice(params: GenerateInvoiceParams) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can generate invoices');\r\n  }\r\n\r\n  const { organizationId, periodStart, periodEnd } = params;\r\n\r\n  // Check if invoice already exists for this period\r\n  const { data: existing } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select('id')\r\n    .eq('organization_id', organizationId)\r\n    .eq('period_start', periodStart)\r\n    .eq('period_end', periodEnd)\r\n    .single();\r\n\r\n  if (existing) {\r\n    throw new Error('Invoice already exists for this period');\r\n  }\r\n\r\n  // Calculate amounts using the database function\r\n  const { data: amounts, error: calcError } = await serviceSupabase\r\n    .rpc('calculate_invoice_amounts', {\r\n      p_organization_id: organizationId,\r\n      p_period_start: periodStart,\r\n      p_period_end: periodEnd\r\n    });\r\n\r\n  if (calcError) throw calcError;\r\n\r\n  const totalAmount = amounts?.[0]?.total_amount_paisa || 0;\r\n  const totalTransactions = amounts?.[0]?.total_transactions || 0;\r\n\r\n  // Generate invoice number\r\n  const { data: invoiceNumber } = await serviceSupabase\r\n    .rpc('generate_invoice_number');\r\n\r\n  // Create invoice\r\n  const { data: invoice, error: insertError } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .insert({\r\n      organization_id: organizationId,\r\n      invoice_number: invoiceNumber,\r\n      period_start: periodStart,\r\n      period_end: periodEnd,\r\n      total_coin_transactions: totalTransactions,\r\n      total_amount_paisa: totalAmount,\r\n      amount_paid_paisa: 0,\r\n      amount_due_paisa: totalAmount,\r\n      status: totalAmount > 0 ? 'pending' : 'draft'\r\n    })\r\n    .select()\r\n    .single();\r\n\r\n  if (insertError) throw insertError;\r\n\r\n  return { success: true, invoice };\r\n}\r\n\r\n/**\r\n * Generate invoices for all organizations for the previous month\r\n */\r\nexport async function generateMonthlyInvoices() {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can generate invoices');\r\n  }\r\n\r\n  // Get all active organizations\r\n  const { data: organizations } = await serviceSupabase\r\n    .from('organizations')\r\n    .select('id, name');\r\n\r\n  if (!organizations) return { success: false, message: 'No organizations found' };\r\n\r\n  // Calculate previous month period\r\n  const now = new Date();\r\n  const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);\r\n  const periodStart = lastMonth.toISOString();\r\n  const periodEnd = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();\r\n\r\n  const results = [];\r\n\r\n  for (const org of organizations) {\r\n    try {\r\n      const result = await generateInvoice({\r\n        organizationId: org.id,\r\n        periodStart,\r\n        periodEnd\r\n      });\r\n      results.push({ organizationId: org.id, name: org.name, success: true, invoice: result.invoice });\r\n    } catch (error: any) {\r\n      results.push({ organizationId: org.id, name: org.name, success: false, error: error.message });\r\n    }\r\n  }\r\n\r\n  return { success: true, results };\r\n}\r\n\r\n/**\r\n * Send invoice email to organization\r\n */\r\nexport async function sendInvoiceEmail(params: SendInvoiceEmailParams) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can send invoice emails');\r\n  }\r\n\r\n  const { invoiceId } = params;\r\n\r\n  // Get invoice with organization details\r\n  const { data: invoice, error: fetchError } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select(`\r\n      *,\r\n      organizations (\r\n        id,\r\n        name,\r\n        contact_email\r\n      )\r\n    `)\r\n    .eq('id', invoiceId)\r\n    .single();\r\n\r\n  if (fetchError || !invoice) {\r\n    throw new Error('Invoice not found');\r\n  }\r\n\r\n  if (!invoice.organizations.contact_email) {\r\n    throw new Error('Organization does not have a contact email');\r\n  }\r\n\r\n  // Import email utilities\r\n  const { sendEmail, generateInvoiceEmailHTML } = await import('@/lib/email');\r\n  \r\n  // Generate email content\r\n  const appUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://lyra-app.co.in';\r\n  const invoiceUrl = `${appUrl}/admin/billing/${invoice.id}`;\r\n  const paymentUrl = `${appUrl}/admin/billing/${invoice.id}/pay`;\r\n  \r\n  const formatCurrency = (paisa: number) => {\r\n    return `â‚¹${(paisa / 100).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\r\n  };\r\n\r\n  const formatDate = (date: string) => {\r\n    return new Date(date).toLocaleDateString('en-IN', {\r\n      day: '2-digit',\r\n      month: 'short',\r\n      year: 'numeric'\r\n    });\r\n  };\r\n\r\n  const emailHTML = generateInvoiceEmailHTML({\r\n    invoiceNumber: invoice.invoice_number,\r\n    organizationName: invoice.organizations.name,\r\n    totalAmount: formatCurrency(invoice.total_amount_paisa),\r\n    dueDate: invoice.status === 'paid' && invoice.paid_at \r\n      ? formatDate(invoice.paid_at)\r\n      : 'Upon Receipt',\r\n    invoiceUrl,\r\n    paymentUrl,\r\n  });\r\n\r\n  // Send email\r\n  const result = await sendEmail({\r\n    to: invoice.organizations.contact_email,\r\n    subject: `Invoice ${invoice.invoice_number} from Lyra Enterprises`,\r\n    html: emailHTML,\r\n  });\r\n\r\n  if (!result.success) {\r\n    throw new Error(`Failed to send email: ${result.error}`);\r\n  }\r\n\r\n  // Update invoice email tracking\r\n  await serviceSupabase\r\n    .from('organization_invoices')\r\n    .update({\r\n      email_sent: true,\r\n      email_sent_at: new Date().toISOString(),\r\n      reminder_count: (invoice.reminder_count || 0) + 1,\r\n      last_reminder_sent_at: new Date().toISOString()\r\n    })\r\n    .eq('id', invoiceId);\r\n\r\n  return { success: true, invoice, message: `Email sent to ${invoice.organizations.contact_email}` };\r\n}\r\n\r\n/**\r\n * Record a manual payment for an invoice\r\n */\r\nexport async function recordManualPayment(params: RecordPaymentParams) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can record payments');\r\n  }\r\n\r\n  const { invoiceId, amountPaisa, notes } = params;\r\n\r\n  // Get invoice\r\n  const { data: invoice, error: fetchError } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select('*, organizations(id)')\r\n    .eq('id', invoiceId)\r\n    .single();\r\n\r\n  if (fetchError || !invoice) {\r\n    throw new Error('Invoice not found');\r\n  }\r\n\r\n  // Create payment record\r\n  const { data: payment, error: paymentError } = await serviceSupabase\r\n    .from('organization_payments')\r\n    .insert({\r\n      invoice_id: invoiceId,\r\n      organization_id: invoice.organizations.id,\r\n      amount_paisa: amountPaisa,\r\n      payment_method: 'manual',\r\n      status: 'success',\r\n      notes: notes || 'Manual payment recorded by admin',\r\n      payment_date: new Date().toISOString()\r\n    })\r\n    .select()\r\n    .single();\r\n\r\n  if (paymentError) throw paymentError;\r\n\r\n  return { success: true, payment };\r\n}\r\n\r\n/**\r\n * Get all invoices with organization details\r\n */\r\nexport async function getAllInvoices() {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Unauthorized');\r\n  }\r\n\r\n  const { data: invoices, error } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select(`\r\n      *,\r\n      organizations (\r\n        id,\r\n        name,\r\n        email\r\n      )\r\n    `)\r\n    .order('created_at', { ascending: false });\r\n\r\n  if (error) throw error;\r\n\r\n  return { success: true, invoices };\r\n}\r\n\r\n/**\r\n * Get invoice details with payments\r\n */\r\nexport async function getInvoiceDetails(invoiceId: string) {\r\n  const supabase = await createClient();\r\n  \r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n\r\n  const { data: invoice, error } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select(`\r\n      *,\r\n      organizations (\r\n        id,\r\n        name,\r\n        email\r\n      ),\r\n      organization_payments (\r\n        id,\r\n        amount_paisa,\r\n        payment_method,\r\n        status,\r\n        payment_date,\r\n        razorpay_payment_id,\r\n        notes\r\n      )\r\n    `)\r\n    .eq('id', invoiceId)\r\n    .single();\r\n\r\n  if (error) throw error;\r\n\r\n  return { success: true, invoice };\r\n}\r\n\r\n/**\r\n * Delete an invoice and all associated payments\r\n */\r\nexport async function deleteInvoice(invoiceId: string) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can delete invoices');\r\n  }\r\n\r\n  // Delete invoice (cascade will delete associated payments)\r\n  const { error } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .delete()\r\n    .eq('id', invoiceId);\r\n\r\n  if (error) throw error;\r\n\r\n  // Revalidate the billing page to reflect changes\r\n  const { revalidatePath } = await import('next/cache');\r\n  revalidatePath('/admin/billing');\r\n\r\n  return { success: true, message: 'Invoice deleted successfully' };\r\n}\r\n"],"names":[],"mappings":";;;;;;;IA6JsB,mBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA"}},
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///E:/lyra-app-v3/src/components/SendInvoiceEmailButton.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { Send, Loader2, Check } from 'lucide-react';\r\nimport { sendInvoiceEmail } from '@/app/actions/organization-billing';\r\n\r\ninterface SendInvoiceEmailButtonProps {\r\n  invoiceId: string;\r\n}\r\n\r\nexport function SendInvoiceEmailButton({ invoiceId }: SendInvoiceEmailButtonProps) {\r\n  const [loading, setLoading] = useState(false);\r\n  const [sent, setSent] = useState(false);\r\n  const [message, setMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);\r\n\r\n  const handleSend = async () => {\r\n    if (!confirm('Send invoice email to organization?')) {\r\n      return;\r\n    }\r\n\r\n    setLoading(true);\r\n    setMessage(null);\r\n\r\n    try {\r\n      const result = await sendInvoiceEmail({ invoiceId });\r\n      \r\n      if (result.success) {\r\n        setSent(true);\r\n        setMessage({ \r\n          type: 'success', \r\n          text: result.message || 'Invoice email sent successfully!' \r\n        });\r\n        setTimeout(() => {\r\n          setSent(false);\r\n          setMessage(null);\r\n        }, 5000);\r\n      } else {\r\n        setMessage({ type: 'error', text: 'Failed to send email' });\r\n      }\r\n    } catch (error: any) {\r\n      setMessage({ \r\n        type: 'error', \r\n        text: error.message || 'Failed to send email' \r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <button\r\n        onClick={handleSend}\r\n        disabled={loading || sent}\r\n        className={`inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded transition-colors ${\r\n          sent \r\n            ? 'bg-green-600 text-white' \r\n            : 'bg-blue-600 text-white hover:bg-blue-700'\r\n        } disabled:opacity-50 disabled:cursor-not-allowed`}\r\n        title=\"Send Invoice Email\"\r\n      >\r\n        {loading ? (\r\n          <>\r\n            <Loader2 className=\"h-3.5 w-3.5 animate-spin\" />\r\n            Sending...\r\n          </>\r\n        ) : sent ? (\r\n          <>\r\n            <Check className=\"h-3.5 w-3.5\" />\r\n            Sent\r\n          </>\r\n        ) : (\r\n          <>\r\n            <Send className=\"h-3.5 w-3.5\" />\r\n            Email\r\n          </>\r\n        )}\r\n      </button>\r\n    </>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAAA;AAAA;AACA;AAJA;;;;;AAUO,SAAS,uBAAuB,EAAE,SAAS,EAA+B;IAC/E,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,iNAAQ,EAAC;IACvC,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,iNAAQ,EAAC;IACjC,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,iNAAQ,EAAqD;IAE3F,MAAM,aAAa;QACjB,IAAI,CAAC,QAAQ,wCAAwC;YACnD;QACF;QAEA,WAAW;QACX,WAAW;QAEX,IAAI;YACF,MAAM,SAAS,MAAM,IAAA,iLAAgB,EAAC;gBAAE;YAAU;YAElD,IAAI,OAAO,OAAO,EAAE;gBAClB,QAAQ;gBACR,WAAW;oBACT,MAAM;oBACN,MAAM,OAAO,OAAO,IAAI;gBAC1B;gBACA,WAAW;oBACT,QAAQ;oBACR,WAAW;gBACb,GAAG;YACL,OAAO;gBACL,WAAW;oBAAE,MAAM;oBAAS,MAAM;gBAAuB;YAC3D;QACF,EAAE,OAAO,OAAY;YACnB,WAAW;gBACT,MAAM;gBACN,MAAM,MAAM,OAAO,IAAI;YACzB;QACF,SAAU;YACR,WAAW;QACb;IACF;IAEA,qBACE;kBACE,cAAA,8OAAC;YACC,SAAS;YACT,UAAU,WAAW;YACrB,WAAW,CAAC,2FAA2F,EACrG,OACI,4BACA,2CACL,gDAAgD,CAAC;YAClD,OAAM;sBAEL,wBACC;;kCACE,8OAAC,4NAAO;wBAAC,WAAU;;;;;;oBAA6B;;+BAGhD,qBACF;;kCACE,8OAAC,6MAAK;wBAAC,WAAU;;;;;;oBAAgB;;6CAInC;;kCACE,8OAAC,0MAAI;wBAAC,WAAU;;;;;;oBAAgB;;;;;;;;;AAO5C"}}]
}