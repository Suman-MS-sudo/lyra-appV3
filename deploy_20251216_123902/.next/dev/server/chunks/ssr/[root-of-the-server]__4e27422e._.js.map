{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///E:/lyra-app-v3/src/app/actions/organization-billing.ts"],"sourcesContent":["'use server';\r\n\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { createClient as createServiceClient } from '@supabase/supabase-js';\r\n\r\nconst serviceSupabase = createServiceClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n);\r\n\r\ninterface GenerateInvoiceParams {\r\n  organizationId: string;\r\n  periodStart: string;\r\n  periodEnd: string;\r\n}\r\n\r\ninterface SendInvoiceEmailParams {\r\n  invoiceId: string;\r\n}\r\n\r\ninterface RecordPaymentParams {\r\n  invoiceId: string;\r\n  amountPaisa: number;\r\n  razorpayOrderId?: string;\r\n  razorpayPaymentId?: string;\r\n  razorpaySignature?: string;\r\n  notes?: string;\r\n}\r\n\r\n/**\r\n * Generate invoice for an organization for a specific period\r\n */\r\nexport async function generateInvoice(params: GenerateInvoiceParams) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can generate invoices');\r\n  }\r\n\r\n  const { organizationId, periodStart, periodEnd } = params;\r\n\r\n  // Check if invoice already exists for this period\r\n  const { data: existing } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select('id')\r\n    .eq('organization_id', organizationId)\r\n    .eq('period_start', periodStart)\r\n    .eq('period_end', periodEnd)\r\n    .single();\r\n\r\n  if (existing) {\r\n    throw new Error('Invoice already exists for this period');\r\n  }\r\n\r\n  // Calculate amounts using the database function\r\n  const { data: amounts, error: calcError } = await serviceSupabase\r\n    .rpc('calculate_invoice_amounts', {\r\n      p_organization_id: organizationId,\r\n      p_period_start: periodStart,\r\n      p_period_end: periodEnd\r\n    });\r\n\r\n  if (calcError) throw calcError;\r\n\r\n  const totalAmount = amounts?.[0]?.total_amount_paisa || 0;\r\n  const totalTransactions = amounts?.[0]?.total_transactions || 0;\r\n\r\n  // Generate invoice number\r\n  const { data: invoiceNumber } = await serviceSupabase\r\n    .rpc('generate_invoice_number');\r\n\r\n  // Create invoice\r\n  const { data: invoice, error: insertError } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .insert({\r\n      organization_id: organizationId,\r\n      invoice_number: invoiceNumber,\r\n      period_start: periodStart,\r\n      period_end: periodEnd,\r\n      total_coin_transactions: totalTransactions,\r\n      total_amount_paisa: totalAmount,\r\n      amount_paid_paisa: 0,\r\n      amount_due_paisa: totalAmount,\r\n      status: totalAmount > 0 ? 'pending' : 'draft'\r\n    })\r\n    .select()\r\n    .single();\r\n\r\n  if (insertError) throw insertError;\r\n\r\n  return { success: true, invoice };\r\n}\r\n\r\n/**\r\n * Generate invoices for all organizations for the previous month\r\n */\r\nexport async function generateMonthlyInvoices() {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can generate invoices');\r\n  }\r\n\r\n  // Get all active organizations\r\n  const { data: organizations } = await serviceSupabase\r\n    .from('organizations')\r\n    .select('id, name');\r\n\r\n  if (!organizations) return { success: false, message: 'No organizations found' };\r\n\r\n  // Calculate previous month period\r\n  const now = new Date();\r\n  const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);\r\n  const periodStart = lastMonth.toISOString();\r\n  const periodEnd = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();\r\n\r\n  const results = [];\r\n\r\n  for (const org of organizations) {\r\n    try {\r\n      const result = await generateInvoice({\r\n        organizationId: org.id,\r\n        periodStart,\r\n        periodEnd\r\n      });\r\n      results.push({ organizationId: org.id, name: org.name, success: true, invoice: result.invoice });\r\n    } catch (error: any) {\r\n      results.push({ organizationId: org.id, name: org.name, success: false, error: error.message });\r\n    }\r\n  }\r\n\r\n  return { success: true, results };\r\n}\r\n\r\n/**\r\n * Send invoice email to organization\r\n */\r\nexport async function sendInvoiceEmail(params: SendInvoiceEmailParams) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can send invoice emails');\r\n  }\r\n\r\n  const { invoiceId } = params;\r\n\r\n  // Get invoice with organization details\r\n  const { data: invoice, error: fetchError } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select(`\r\n      *,\r\n      organizations (\r\n        id,\r\n        name,\r\n        contact_email\r\n      )\r\n    `)\r\n    .eq('id', invoiceId)\r\n    .single();\r\n\r\n  if (fetchError || !invoice) {\r\n    throw new Error('Invoice not found');\r\n  }\r\n\r\n  if (!invoice.organizations.contact_email) {\r\n    throw new Error('Organization does not have a contact email');\r\n  }\r\n\r\n  // Import email utilities\r\n  const { sendEmail, generateInvoiceEmailHTML } = await import('@/lib/email');\r\n  \r\n  // Generate email content\r\n  const appUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://lyra-app.co.in';\r\n  const invoiceUrl = `${appUrl}/admin/billing/${invoice.id}`;\r\n  const paymentUrl = `${appUrl}/admin/billing/${invoice.id}/pay`;\r\n  \r\n  const formatCurrency = (paisa: number) => {\r\n    return `₹${(paisa / 100).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\r\n  };\r\n\r\n  const formatDate = (date: string) => {\r\n    return new Date(date).toLocaleDateString('en-IN', {\r\n      day: '2-digit',\r\n      month: 'short',\r\n      year: 'numeric'\r\n    });\r\n  };\r\n\r\n  // Calculate due date: 30 days from invoice creation\r\n  const dueDate = new Date(invoice.created_at);\r\n  dueDate.setDate(dueDate.getDate() + 30);\r\n\r\n  const emailHTML = generateInvoiceEmailHTML({\r\n    invoiceNumber: invoice.invoice_number,\r\n    organizationName: invoice.organizations.name,\r\n    totalAmount: formatCurrency(invoice.total_amount_paisa),\r\n    dueDate: invoice.status === 'paid' && invoice.paid_at \r\n      ? `Paid on ${formatDate(invoice.paid_at)}`\r\n      : formatDate(dueDate.toISOString()),\r\n    invoiceUrl,\r\n    paymentUrl,\r\n    totalAmountPaisa: invoice.total_amount_paisa,\r\n  });\r\n\r\n  // Determine email subject based on amount\r\n  const emailSubject = invoice.total_amount_paisa === 0\r\n    ? `Monthly Statement ${invoice.invoice_number} - No Payment Required`\r\n    : `Invoice ${invoice.invoice_number} from Lyra Enterprises`;\r\n\r\n  // Send email\r\n  const result = await sendEmail({\r\n    to: invoice.organizations.contact_email,\r\n    subject: emailSubject,\r\n    html: emailHTML,\r\n  });\r\n\r\n  if (!result.success) {\r\n    throw new Error(`Failed to send email: ${result.error}`);\r\n  }\r\n\r\n  // Update invoice email tracking\r\n  await serviceSupabase\r\n    .from('organization_invoices')\r\n    .update({\r\n      email_sent: true,\r\n      email_sent_at: new Date().toISOString(),\r\n      reminder_count: (invoice.reminder_count || 0) + 1,\r\n      last_reminder_sent_at: new Date().toISOString()\r\n    })\r\n    .eq('id', invoiceId);\r\n\r\n  return { success: true, invoice, message: `Email sent to ${invoice.organizations.contact_email}` };\r\n}\r\n\r\n/**\r\n * Record a manual payment for an invoice\r\n */\r\nexport async function recordManualPayment(params: RecordPaymentParams) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can record payments');\r\n  }\r\n\r\n  const { invoiceId, amountPaisa, notes } = params;\r\n\r\n  // Get invoice\r\n  const { data: invoice, error: fetchError } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select('*, organizations(id)')\r\n    .eq('id', invoiceId)\r\n    .single();\r\n\r\n  if (fetchError || !invoice) {\r\n    throw new Error('Invoice not found');\r\n  }\r\n\r\n  // Create payment record\r\n  const { data: payment, error: paymentError } = await serviceSupabase\r\n    .from('organization_payments')\r\n    .insert({\r\n      invoice_id: invoiceId,\r\n      organization_id: invoice.organizations.id,\r\n      amount_paisa: amountPaisa,\r\n      payment_method: 'manual',\r\n      status: 'success',\r\n      notes: notes || 'Manual payment recorded by admin',\r\n      payment_date: new Date().toISOString()\r\n    })\r\n    .select()\r\n    .single();\r\n\r\n  if (paymentError) throw paymentError;\r\n\r\n  return { success: true, payment };\r\n}\r\n\r\n/**\r\n * Get all invoices with organization details\r\n */\r\nexport async function getAllInvoices() {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Unauthorized');\r\n  }\r\n\r\n  const { data: invoices, error } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select(`\r\n      *,\r\n      organizations (\r\n        id,\r\n        name,\r\n        email\r\n      )\r\n    `)\r\n    .order('created_at', { ascending: false });\r\n\r\n  if (error) throw error;\r\n\r\n  return { success: true, invoices };\r\n}\r\n\r\n/**\r\n * Get invoice details with payments\r\n */\r\nexport async function getInvoiceDetails(invoiceId: string) {\r\n  const supabase = await createClient();\r\n  \r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n\r\n  const { data: invoice, error } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select(`\r\n      *,\r\n      organizations (\r\n        id,\r\n        name,\r\n        email\r\n      ),\r\n      organization_payments (\r\n        id,\r\n        amount_paisa,\r\n        payment_method,\r\n        status,\r\n        payment_date,\r\n        razorpay_payment_id,\r\n        notes\r\n      )\r\n    `)\r\n    .eq('id', invoiceId)\r\n    .single();\r\n\r\n  if (error) throw error;\r\n\r\n  return { success: true, invoice };\r\n}\r\n\r\n/**\r\n * Delete an invoice and all associated payments\r\n */\r\nexport async function deleteInvoice(invoiceId: string) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can delete invoices');\r\n  }\r\n\r\n  // Delete invoice (cascade will delete associated payments)\r\n  const { error } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .delete()\r\n    .eq('id', invoiceId);\r\n\r\n  if (error) throw error;\r\n\r\n  // Revalidate the billing page to reflect changes\r\n  const { revalidatePath } = await import('next/cache');\r\n  revalidatePath('/admin/billing');\r\n\r\n  return { success: true, message: 'Invoice deleted successfully' };\r\n}\r\n"],"names":[],"mappings":";;;;;;;IA0GsB,0BAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA"}},
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///E:/lyra-app-v3/src/components/GenerateMonthlyInvoicesButton.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { FileText, Loader2 } from 'lucide-react';\r\nimport { generateMonthlyInvoices } from '@/app/actions/organization-billing';\r\n\r\nexport function GenerateMonthlyInvoicesButton() {\r\n  const [loading, setLoading] = useState(false);\r\n  const [message, setMessage] = useState<string | null>(null);\r\n\r\n  const handleGenerate = async () => {\r\n    if (!confirm('This will generate invoices for all organizations for the previous month. Continue?')) {\r\n      return;\r\n    }\r\n\r\n    setLoading(true);\r\n    setMessage(null);\r\n\r\n    try {\r\n      const result = await generateMonthlyInvoices();\r\n      \r\n      if (result.success) {\r\n        const successCount = result.results?.filter(r => r.success).length || 0;\r\n        const totalCount = result.results?.length || 0;\r\n        setMessage(`Successfully generated ${successCount} out of ${totalCount} invoices`);\r\n        \r\n        // Refresh page after 2 seconds\r\n        setTimeout(() => window.location.reload(), 2000);\r\n      }\r\n    } catch (error: any) {\r\n      setMessage(`Error: ${error.message}`);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div>\r\n      <button\r\n        onClick={handleGenerate}\r\n        disabled={loading}\r\n        className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed\"\r\n      >\r\n        {loading ? (\r\n          <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n        ) : (\r\n          <FileText className=\"h-4 w-4\" />\r\n        )}\r\n        Generate Monthly Invoices\r\n      </button>\r\n      \r\n      {message && (\r\n        <div className={`mt-2 text-sm ${message.startsWith('Error') ? 'text-red-600' : 'text-green-600'}`}>\r\n          {message}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAAA;AACA;AAJA;;;;;AAMO,SAAS;IACd,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,iNAAQ,EAAC;IACvC,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,iNAAQ,EAAgB;IAEtD,MAAM,iBAAiB;QACrB,IAAI,CAAC,QAAQ,wFAAwF;YACnG;QACF;QAEA,WAAW;QACX,WAAW;QAEX,IAAI;YACF,MAAM,SAAS,MAAM,IAAA,wLAAuB;YAE5C,IAAI,OAAO,OAAO,EAAE;gBAClB,MAAM,eAAe,OAAO,OAAO,EAAE,OAAO,CAAA,IAAK,EAAE,OAAO,EAAE,UAAU;gBACtE,MAAM,aAAa,OAAO,OAAO,EAAE,UAAU;gBAC7C,WAAW,CAAC,uBAAuB,EAAE,aAAa,QAAQ,EAAE,WAAW,SAAS,CAAC;gBAEjF,+BAA+B;gBAC/B,WAAW,IAAM,OAAO,QAAQ,CAAC,MAAM,IAAI;YAC7C;QACF,EAAE,OAAO,OAAY;YACnB,WAAW,CAAC,OAAO,EAAE,MAAM,OAAO,EAAE;QACtC,SAAU;YACR,WAAW;QACb;IACF;IAEA,qBACE,8OAAC;;0BACC,8OAAC;gBACC,SAAS;gBACT,UAAU;gBACV,WAAU;;oBAET,wBACC,8OAAC,4NAAO;wBAAC,WAAU;;;;;6CAEnB,8OAAC,0NAAQ;wBAAC,WAAU;;;;;;oBACpB;;;;;;;YAIH,yBACC,8OAAC;gBAAI,WAAW,CAAC,aAAa,EAAE,QAAQ,UAAU,CAAC,WAAW,iBAAiB,kBAAkB;0BAC9F;;;;;;;;;;;;AAKX"}},
    {"offset": {"line": 106, "column": 0}, "map": {"version":3,"sources":["file:///E:/lyra-app-v3/src/app/actions/organization-billing.ts"],"sourcesContent":["'use server';\r\n\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { createClient as createServiceClient } from '@supabase/supabase-js';\r\n\r\nconst serviceSupabase = createServiceClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n);\r\n\r\ninterface GenerateInvoiceParams {\r\n  organizationId: string;\r\n  periodStart: string;\r\n  periodEnd: string;\r\n}\r\n\r\ninterface SendInvoiceEmailParams {\r\n  invoiceId: string;\r\n}\r\n\r\ninterface RecordPaymentParams {\r\n  invoiceId: string;\r\n  amountPaisa: number;\r\n  razorpayOrderId?: string;\r\n  razorpayPaymentId?: string;\r\n  razorpaySignature?: string;\r\n  notes?: string;\r\n}\r\n\r\n/**\r\n * Generate invoice for an organization for a specific period\r\n */\r\nexport async function generateInvoice(params: GenerateInvoiceParams) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can generate invoices');\r\n  }\r\n\r\n  const { organizationId, periodStart, periodEnd } = params;\r\n\r\n  // Check if invoice already exists for this period\r\n  const { data: existing } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select('id')\r\n    .eq('organization_id', organizationId)\r\n    .eq('period_start', periodStart)\r\n    .eq('period_end', periodEnd)\r\n    .single();\r\n\r\n  if (existing) {\r\n    throw new Error('Invoice already exists for this period');\r\n  }\r\n\r\n  // Calculate amounts using the database function\r\n  const { data: amounts, error: calcError } = await serviceSupabase\r\n    .rpc('calculate_invoice_amounts', {\r\n      p_organization_id: organizationId,\r\n      p_period_start: periodStart,\r\n      p_period_end: periodEnd\r\n    });\r\n\r\n  if (calcError) throw calcError;\r\n\r\n  const totalAmount = amounts?.[0]?.total_amount_paisa || 0;\r\n  const totalTransactions = amounts?.[0]?.total_transactions || 0;\r\n\r\n  // Generate invoice number\r\n  const { data: invoiceNumber } = await serviceSupabase\r\n    .rpc('generate_invoice_number');\r\n\r\n  // Create invoice\r\n  const { data: invoice, error: insertError } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .insert({\r\n      organization_id: organizationId,\r\n      invoice_number: invoiceNumber,\r\n      period_start: periodStart,\r\n      period_end: periodEnd,\r\n      total_coin_transactions: totalTransactions,\r\n      total_amount_paisa: totalAmount,\r\n      amount_paid_paisa: 0,\r\n      amount_due_paisa: totalAmount,\r\n      status: totalAmount > 0 ? 'pending' : 'draft'\r\n    })\r\n    .select()\r\n    .single();\r\n\r\n  if (insertError) throw insertError;\r\n\r\n  return { success: true, invoice };\r\n}\r\n\r\n/**\r\n * Generate invoices for all organizations for the previous month\r\n */\r\nexport async function generateMonthlyInvoices() {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can generate invoices');\r\n  }\r\n\r\n  // Get all active organizations\r\n  const { data: organizations } = await serviceSupabase\r\n    .from('organizations')\r\n    .select('id, name');\r\n\r\n  if (!organizations) return { success: false, message: 'No organizations found' };\r\n\r\n  // Calculate previous month period\r\n  const now = new Date();\r\n  const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);\r\n  const periodStart = lastMonth.toISOString();\r\n  const periodEnd = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();\r\n\r\n  const results = [];\r\n\r\n  for (const org of organizations) {\r\n    try {\r\n      const result = await generateInvoice({\r\n        organizationId: org.id,\r\n        periodStart,\r\n        periodEnd\r\n      });\r\n      results.push({ organizationId: org.id, name: org.name, success: true, invoice: result.invoice });\r\n    } catch (error: any) {\r\n      results.push({ organizationId: org.id, name: org.name, success: false, error: error.message });\r\n    }\r\n  }\r\n\r\n  return { success: true, results };\r\n}\r\n\r\n/**\r\n * Send invoice email to organization\r\n */\r\nexport async function sendInvoiceEmail(params: SendInvoiceEmailParams) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can send invoice emails');\r\n  }\r\n\r\n  const { invoiceId } = params;\r\n\r\n  // Get invoice with organization details\r\n  const { data: invoice, error: fetchError } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select(`\r\n      *,\r\n      organizations (\r\n        id,\r\n        name,\r\n        contact_email\r\n      )\r\n    `)\r\n    .eq('id', invoiceId)\r\n    .single();\r\n\r\n  if (fetchError || !invoice) {\r\n    throw new Error('Invoice not found');\r\n  }\r\n\r\n  if (!invoice.organizations.contact_email) {\r\n    throw new Error('Organization does not have a contact email');\r\n  }\r\n\r\n  // Import email utilities\r\n  const { sendEmail, generateInvoiceEmailHTML } = await import('@/lib/email');\r\n  \r\n  // Generate email content\r\n  const appUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://lyra-app.co.in';\r\n  const invoiceUrl = `${appUrl}/admin/billing/${invoice.id}`;\r\n  const paymentUrl = `${appUrl}/admin/billing/${invoice.id}/pay`;\r\n  \r\n  const formatCurrency = (paisa: number) => {\r\n    return `₹${(paisa / 100).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\r\n  };\r\n\r\n  const formatDate = (date: string) => {\r\n    return new Date(date).toLocaleDateString('en-IN', {\r\n      day: '2-digit',\r\n      month: 'short',\r\n      year: 'numeric'\r\n    });\r\n  };\r\n\r\n  // Calculate due date: 30 days from invoice creation\r\n  const dueDate = new Date(invoice.created_at);\r\n  dueDate.setDate(dueDate.getDate() + 30);\r\n\r\n  const emailHTML = generateInvoiceEmailHTML({\r\n    invoiceNumber: invoice.invoice_number,\r\n    organizationName: invoice.organizations.name,\r\n    totalAmount: formatCurrency(invoice.total_amount_paisa),\r\n    dueDate: invoice.status === 'paid' && invoice.paid_at \r\n      ? `Paid on ${formatDate(invoice.paid_at)}`\r\n      : formatDate(dueDate.toISOString()),\r\n    invoiceUrl,\r\n    paymentUrl,\r\n    totalAmountPaisa: invoice.total_amount_paisa,\r\n  });\r\n\r\n  // Determine email subject based on amount\r\n  const emailSubject = invoice.total_amount_paisa === 0\r\n    ? `Monthly Statement ${invoice.invoice_number} - No Payment Required`\r\n    : `Invoice ${invoice.invoice_number} from Lyra Enterprises`;\r\n\r\n  // Send email\r\n  const result = await sendEmail({\r\n    to: invoice.organizations.contact_email,\r\n    subject: emailSubject,\r\n    html: emailHTML,\r\n  });\r\n\r\n  if (!result.success) {\r\n    throw new Error(`Failed to send email: ${result.error}`);\r\n  }\r\n\r\n  // Update invoice email tracking\r\n  await serviceSupabase\r\n    .from('organization_invoices')\r\n    .update({\r\n      email_sent: true,\r\n      email_sent_at: new Date().toISOString(),\r\n      reminder_count: (invoice.reminder_count || 0) + 1,\r\n      last_reminder_sent_at: new Date().toISOString()\r\n    })\r\n    .eq('id', invoiceId);\r\n\r\n  return { success: true, invoice, message: `Email sent to ${invoice.organizations.contact_email}` };\r\n}\r\n\r\n/**\r\n * Record a manual payment for an invoice\r\n */\r\nexport async function recordManualPayment(params: RecordPaymentParams) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can record payments');\r\n  }\r\n\r\n  const { invoiceId, amountPaisa, notes } = params;\r\n\r\n  // Get invoice\r\n  const { data: invoice, error: fetchError } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select('*, organizations(id)')\r\n    .eq('id', invoiceId)\r\n    .single();\r\n\r\n  if (fetchError || !invoice) {\r\n    throw new Error('Invoice not found');\r\n  }\r\n\r\n  // Create payment record\r\n  const { data: payment, error: paymentError } = await serviceSupabase\r\n    .from('organization_payments')\r\n    .insert({\r\n      invoice_id: invoiceId,\r\n      organization_id: invoice.organizations.id,\r\n      amount_paisa: amountPaisa,\r\n      payment_method: 'manual',\r\n      status: 'success',\r\n      notes: notes || 'Manual payment recorded by admin',\r\n      payment_date: new Date().toISOString()\r\n    })\r\n    .select()\r\n    .single();\r\n\r\n  if (paymentError) throw paymentError;\r\n\r\n  return { success: true, payment };\r\n}\r\n\r\n/**\r\n * Get all invoices with organization details\r\n */\r\nexport async function getAllInvoices() {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Unauthorized');\r\n  }\r\n\r\n  const { data: invoices, error } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select(`\r\n      *,\r\n      organizations (\r\n        id,\r\n        name,\r\n        email\r\n      )\r\n    `)\r\n    .order('created_at', { ascending: false });\r\n\r\n  if (error) throw error;\r\n\r\n  return { success: true, invoices };\r\n}\r\n\r\n/**\r\n * Get invoice details with payments\r\n */\r\nexport async function getInvoiceDetails(invoiceId: string) {\r\n  const supabase = await createClient();\r\n  \r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n\r\n  const { data: invoice, error } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select(`\r\n      *,\r\n      organizations (\r\n        id,\r\n        name,\r\n        email\r\n      ),\r\n      organization_payments (\r\n        id,\r\n        amount_paisa,\r\n        payment_method,\r\n        status,\r\n        payment_date,\r\n        razorpay_payment_id,\r\n        notes\r\n      )\r\n    `)\r\n    .eq('id', invoiceId)\r\n    .single();\r\n\r\n  if (error) throw error;\r\n\r\n  return { success: true, invoice };\r\n}\r\n\r\n/**\r\n * Delete an invoice and all associated payments\r\n */\r\nexport async function deleteInvoice(invoiceId: string) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can delete invoices');\r\n  }\r\n\r\n  // Delete invoice (cascade will delete associated payments)\r\n  const { error } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .delete()\r\n    .eq('id', invoiceId);\r\n\r\n  if (error) throw error;\r\n\r\n  // Revalidate the billing page to reflect changes\r\n  const { revalidatePath } = await import('next/cache');\r\n  revalidatePath('/admin/billing');\r\n\r\n  return { success: true, message: 'Invoice deleted successfully' };\r\n}\r\n"],"names":[],"mappings":";;;;;;;IA6JsB,mBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA"}},
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///E:/lyra-app-v3/src/components/SendInvoiceEmailButton.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { Send, Loader2, Check } from 'lucide-react';\r\nimport { sendInvoiceEmail } from '@/app/actions/organization-billing';\r\n\r\ninterface SendInvoiceEmailButtonProps {\r\n  invoiceId: string;\r\n}\r\n\r\nexport function SendInvoiceEmailButton({ invoiceId }: SendInvoiceEmailButtonProps) {\r\n  const [loading, setLoading] = useState(false);\r\n  const [sent, setSent] = useState(false);\r\n  const [message, setMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);\r\n\r\n  const handleSend = async () => {\r\n    if (!confirm('Send invoice email to organization?')) {\r\n      return;\r\n    }\r\n\r\n    setLoading(true);\r\n    setMessage(null);\r\n\r\n    try {\r\n      const result = await sendInvoiceEmail({ invoiceId });\r\n      \r\n      if (result.success) {\r\n        setSent(true);\r\n        setMessage({ \r\n          type: 'success', \r\n          text: result.message || 'Invoice email sent successfully!' \r\n        });\r\n        setTimeout(() => {\r\n          setSent(false);\r\n          setMessage(null);\r\n        }, 5000);\r\n      } else {\r\n        setMessage({ type: 'error', text: 'Failed to send email' });\r\n      }\r\n    } catch (error: any) {\r\n      setMessage({ \r\n        type: 'error', \r\n        text: error.message || 'Failed to send email' \r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <button\r\n        onClick={handleSend}\r\n        disabled={loading || sent}\r\n        className={`inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded transition-colors ${\r\n          sent \r\n            ? 'bg-green-600 text-white' \r\n            : 'bg-blue-600 text-white hover:bg-blue-700'\r\n        } disabled:opacity-50 disabled:cursor-not-allowed`}\r\n        title=\"Send Invoice Email\"\r\n      >\r\n        {loading ? (\r\n          <>\r\n            <Loader2 className=\"h-3.5 w-3.5 animate-spin\" />\r\n            Sending...\r\n          </>\r\n        ) : sent ? (\r\n          <>\r\n            <Check className=\"h-3.5 w-3.5\" />\r\n            Sent\r\n          </>\r\n        ) : (\r\n          <>\r\n            <Send className=\"h-3.5 w-3.5\" />\r\n            Email\r\n          </>\r\n        )}\r\n      </button>\r\n    </>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAAA;AAAA;AACA;AAJA;;;;;AAUO,SAAS,uBAAuB,EAAE,SAAS,EAA+B;IAC/E,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,iNAAQ,EAAC;IACvC,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,iNAAQ,EAAC;IACjC,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,iNAAQ,EAAqD;IAE3F,MAAM,aAAa;QACjB,IAAI,CAAC,QAAQ,wCAAwC;YACnD;QACF;QAEA,WAAW;QACX,WAAW;QAEX,IAAI;YACF,MAAM,SAAS,MAAM,IAAA,iLAAgB,EAAC;gBAAE;YAAU;YAElD,IAAI,OAAO,OAAO,EAAE;gBAClB,QAAQ;gBACR,WAAW;oBACT,MAAM;oBACN,MAAM,OAAO,OAAO,IAAI;gBAC1B;gBACA,WAAW;oBACT,QAAQ;oBACR,WAAW;gBACb,GAAG;YACL,OAAO;gBACL,WAAW;oBAAE,MAAM;oBAAS,MAAM;gBAAuB;YAC3D;QACF,EAAE,OAAO,OAAY;YACnB,WAAW;gBACT,MAAM;gBACN,MAAM,MAAM,OAAO,IAAI;YACzB;QACF,SAAU;YACR,WAAW;QACb;IACF;IAEA,qBACE;kBACE,cAAA,8OAAC;YACC,SAAS;YACT,UAAU,WAAW;YACrB,WAAW,CAAC,2FAA2F,EACrG,OACI,4BACA,2CACL,gDAAgD,CAAC;YAClD,OAAM;sBAEL,wBACC;;kCACE,8OAAC,4NAAO;wBAAC,WAAU;;;;;;oBAA6B;;+BAGhD,qBACF;;kCACE,8OAAC,6MAAK;wBAAC,WAAU;;;;;;oBAAgB;;6CAInC;;kCACE,8OAAC,0MAAI;wBAAC,WAAU;;;;;;oBAAgB;;;;;;;;;AAO5C"}},
    {"offset": {"line": 223, "column": 0}, "map": {"version":3,"sources":["file:///E:/lyra-app-v3/src/app/actions/organization-billing.ts"],"sourcesContent":["'use server';\r\n\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { createClient as createServiceClient } from '@supabase/supabase-js';\r\n\r\nconst serviceSupabase = createServiceClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n);\r\n\r\ninterface GenerateInvoiceParams {\r\n  organizationId: string;\r\n  periodStart: string;\r\n  periodEnd: string;\r\n}\r\n\r\ninterface SendInvoiceEmailParams {\r\n  invoiceId: string;\r\n}\r\n\r\ninterface RecordPaymentParams {\r\n  invoiceId: string;\r\n  amountPaisa: number;\r\n  razorpayOrderId?: string;\r\n  razorpayPaymentId?: string;\r\n  razorpaySignature?: string;\r\n  notes?: string;\r\n}\r\n\r\n/**\r\n * Generate invoice for an organization for a specific period\r\n */\r\nexport async function generateInvoice(params: GenerateInvoiceParams) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can generate invoices');\r\n  }\r\n\r\n  const { organizationId, periodStart, periodEnd } = params;\r\n\r\n  // Check if invoice already exists for this period\r\n  const { data: existing } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select('id')\r\n    .eq('organization_id', organizationId)\r\n    .eq('period_start', periodStart)\r\n    .eq('period_end', periodEnd)\r\n    .single();\r\n\r\n  if (existing) {\r\n    throw new Error('Invoice already exists for this period');\r\n  }\r\n\r\n  // Calculate amounts using the database function\r\n  const { data: amounts, error: calcError } = await serviceSupabase\r\n    .rpc('calculate_invoice_amounts', {\r\n      p_organization_id: organizationId,\r\n      p_period_start: periodStart,\r\n      p_period_end: periodEnd\r\n    });\r\n\r\n  if (calcError) throw calcError;\r\n\r\n  const totalAmount = amounts?.[0]?.total_amount_paisa || 0;\r\n  const totalTransactions = amounts?.[0]?.total_transactions || 0;\r\n\r\n  // Generate invoice number\r\n  const { data: invoiceNumber } = await serviceSupabase\r\n    .rpc('generate_invoice_number');\r\n\r\n  // Create invoice\r\n  const { data: invoice, error: insertError } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .insert({\r\n      organization_id: organizationId,\r\n      invoice_number: invoiceNumber,\r\n      period_start: periodStart,\r\n      period_end: periodEnd,\r\n      total_coin_transactions: totalTransactions,\r\n      total_amount_paisa: totalAmount,\r\n      amount_paid_paisa: 0,\r\n      amount_due_paisa: totalAmount,\r\n      status: totalAmount > 0 ? 'pending' : 'draft'\r\n    })\r\n    .select()\r\n    .single();\r\n\r\n  if (insertError) throw insertError;\r\n\r\n  return { success: true, invoice };\r\n}\r\n\r\n/**\r\n * Generate invoices for all organizations for the previous month\r\n */\r\nexport async function generateMonthlyInvoices() {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can generate invoices');\r\n  }\r\n\r\n  // Get all active organizations\r\n  const { data: organizations } = await serviceSupabase\r\n    .from('organizations')\r\n    .select('id, name');\r\n\r\n  if (!organizations) return { success: false, message: 'No organizations found' };\r\n\r\n  // Calculate previous month period\r\n  const now = new Date();\r\n  const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);\r\n  const periodStart = lastMonth.toISOString();\r\n  const periodEnd = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();\r\n\r\n  const results = [];\r\n\r\n  for (const org of organizations) {\r\n    try {\r\n      const result = await generateInvoice({\r\n        organizationId: org.id,\r\n        periodStart,\r\n        periodEnd\r\n      });\r\n      results.push({ organizationId: org.id, name: org.name, success: true, invoice: result.invoice });\r\n    } catch (error: any) {\r\n      results.push({ organizationId: org.id, name: org.name, success: false, error: error.message });\r\n    }\r\n  }\r\n\r\n  return { success: true, results };\r\n}\r\n\r\n/**\r\n * Send invoice email to organization\r\n */\r\nexport async function sendInvoiceEmail(params: SendInvoiceEmailParams) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can send invoice emails');\r\n  }\r\n\r\n  const { invoiceId } = params;\r\n\r\n  // Get invoice with organization details\r\n  const { data: invoice, error: fetchError } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select(`\r\n      *,\r\n      organizations (\r\n        id,\r\n        name,\r\n        contact_email\r\n      )\r\n    `)\r\n    .eq('id', invoiceId)\r\n    .single();\r\n\r\n  if (fetchError || !invoice) {\r\n    throw new Error('Invoice not found');\r\n  }\r\n\r\n  if (!invoice.organizations.contact_email) {\r\n    throw new Error('Organization does not have a contact email');\r\n  }\r\n\r\n  // Import email utilities\r\n  const { sendEmail, generateInvoiceEmailHTML } = await import('@/lib/email');\r\n  \r\n  // Generate email content\r\n  const appUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://lyra-app.co.in';\r\n  const invoiceUrl = `${appUrl}/admin/billing/${invoice.id}`;\r\n  const paymentUrl = `${appUrl}/admin/billing/${invoice.id}/pay`;\r\n  \r\n  const formatCurrency = (paisa: number) => {\r\n    return `₹${(paisa / 100).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\r\n  };\r\n\r\n  const formatDate = (date: string) => {\r\n    return new Date(date).toLocaleDateString('en-IN', {\r\n      day: '2-digit',\r\n      month: 'short',\r\n      year: 'numeric'\r\n    });\r\n  };\r\n\r\n  // Calculate due date: 30 days from invoice creation\r\n  const dueDate = new Date(invoice.created_at);\r\n  dueDate.setDate(dueDate.getDate() + 30);\r\n\r\n  const emailHTML = generateInvoiceEmailHTML({\r\n    invoiceNumber: invoice.invoice_number,\r\n    organizationName: invoice.organizations.name,\r\n    totalAmount: formatCurrency(invoice.total_amount_paisa),\r\n    dueDate: invoice.status === 'paid' && invoice.paid_at \r\n      ? `Paid on ${formatDate(invoice.paid_at)}`\r\n      : formatDate(dueDate.toISOString()),\r\n    invoiceUrl,\r\n    paymentUrl,\r\n    totalAmountPaisa: invoice.total_amount_paisa,\r\n  });\r\n\r\n  // Determine email subject based on amount\r\n  const emailSubject = invoice.total_amount_paisa === 0\r\n    ? `Monthly Statement ${invoice.invoice_number} - No Payment Required`\r\n    : `Invoice ${invoice.invoice_number} from Lyra Enterprises`;\r\n\r\n  // Send email\r\n  const result = await sendEmail({\r\n    to: invoice.organizations.contact_email,\r\n    subject: emailSubject,\r\n    html: emailHTML,\r\n  });\r\n\r\n  if (!result.success) {\r\n    throw new Error(`Failed to send email: ${result.error}`);\r\n  }\r\n\r\n  // Update invoice email tracking\r\n  await serviceSupabase\r\n    .from('organization_invoices')\r\n    .update({\r\n      email_sent: true,\r\n      email_sent_at: new Date().toISOString(),\r\n      reminder_count: (invoice.reminder_count || 0) + 1,\r\n      last_reminder_sent_at: new Date().toISOString()\r\n    })\r\n    .eq('id', invoiceId);\r\n\r\n  return { success: true, invoice, message: `Email sent to ${invoice.organizations.contact_email}` };\r\n}\r\n\r\n/**\r\n * Record a manual payment for an invoice\r\n */\r\nexport async function recordManualPayment(params: RecordPaymentParams) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can record payments');\r\n  }\r\n\r\n  const { invoiceId, amountPaisa, notes } = params;\r\n\r\n  // Get invoice\r\n  const { data: invoice, error: fetchError } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select('*, organizations(id)')\r\n    .eq('id', invoiceId)\r\n    .single();\r\n\r\n  if (fetchError || !invoice) {\r\n    throw new Error('Invoice not found');\r\n  }\r\n\r\n  // Create payment record\r\n  const { data: payment, error: paymentError } = await serviceSupabase\r\n    .from('organization_payments')\r\n    .insert({\r\n      invoice_id: invoiceId,\r\n      organization_id: invoice.organizations.id,\r\n      amount_paisa: amountPaisa,\r\n      payment_method: 'manual',\r\n      status: 'success',\r\n      notes: notes || 'Manual payment recorded by admin',\r\n      payment_date: new Date().toISOString()\r\n    })\r\n    .select()\r\n    .single();\r\n\r\n  if (paymentError) throw paymentError;\r\n\r\n  return { success: true, payment };\r\n}\r\n\r\n/**\r\n * Get all invoices with organization details\r\n */\r\nexport async function getAllInvoices() {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Unauthorized');\r\n  }\r\n\r\n  const { data: invoices, error } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select(`\r\n      *,\r\n      organizations (\r\n        id,\r\n        name,\r\n        email\r\n      )\r\n    `)\r\n    .order('created_at', { ascending: false });\r\n\r\n  if (error) throw error;\r\n\r\n  return { success: true, invoices };\r\n}\r\n\r\n/**\r\n * Get invoice details with payments\r\n */\r\nexport async function getInvoiceDetails(invoiceId: string) {\r\n  const supabase = await createClient();\r\n  \r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n\r\n  const { data: invoice, error } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select(`\r\n      *,\r\n      organizations (\r\n        id,\r\n        name,\r\n        email\r\n      ),\r\n      organization_payments (\r\n        id,\r\n        amount_paisa,\r\n        payment_method,\r\n        status,\r\n        payment_date,\r\n        razorpay_payment_id,\r\n        notes\r\n      )\r\n    `)\r\n    .eq('id', invoiceId)\r\n    .single();\r\n\r\n  if (error) throw error;\r\n\r\n  return { success: true, invoice };\r\n}\r\n\r\n/**\r\n * Delete an invoice and all associated payments\r\n */\r\nexport async function deleteInvoice(invoiceId: string) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can delete invoices');\r\n  }\r\n\r\n  // Delete invoice (cascade will delete associated payments)\r\n  const { error } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .delete()\r\n    .eq('id', invoiceId);\r\n\r\n  if (error) throw error;\r\n\r\n  // Revalidate the billing page to reflect changes\r\n  const { revalidatePath } = await import('next/cache');\r\n  revalidatePath('/admin/billing');\r\n\r\n  return { success: true, message: 'Invoice deleted successfully' };\r\n}\r\n"],"names":[],"mappings":";;;;;;;IA2QsB,sBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA"}},
    {"offset": {"line": 235, "column": 0}, "map": {"version":3,"sources":["file:///E:/lyra-app-v3/src/components/RecordPaymentButton.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { IndianRupee, X } from 'lucide-react';\r\nimport { recordManualPayment } from '@/app/actions/organization-billing';\r\n\r\ninterface RecordPaymentButtonProps {\r\n  invoiceId: string;\r\n  amountDue: number;\r\n  organizationName: string;\r\n}\r\n\r\nexport function RecordPaymentButton({ invoiceId, amountDue, organizationName }: RecordPaymentButtonProps) {\r\n  const [showModal, setShowModal] = useState(false);\r\n  const [amount, setAmount] = useState((amountDue / 100).toFixed(2));\r\n  const [notes, setNotes] = useState('');\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setLoading(true);\r\n\r\n    try {\r\n      const amountPaisa = Math.round(parseFloat(amount) * 100);\r\n      \r\n      const result = await recordManualPayment({\r\n        invoiceId,\r\n        amountPaisa,\r\n        notes: notes || undefined\r\n      });\r\n\r\n      if (result.success) {\r\n        alert('Payment recorded successfully!');\r\n        setShowModal(false);\r\n        window.location.reload();\r\n      }\r\n    } catch (error: any) {\r\n      alert(`Error: ${error.message}`);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <button\r\n        onClick={() => setShowModal(true)}\r\n        className=\"p-2 text-green-600 hover:bg-green-50 rounded-lg transition-colors\"\r\n        title=\"Record Payment\"\r\n      >\r\n        <IndianRupee className=\"h-4 w-4\" />\r\n      </button>\r\n\r\n      {showModal && (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\r\n          <div className=\"bg-white rounded-xl shadow-xl max-w-md w-full mx-4\">\r\n            <div className=\"flex items-center justify-between p-6 border-b\">\r\n              <h3 className=\"text-lg font-semibold text-gray-900\">Record Payment</h3>\r\n              <button\r\n                onClick={() => setShowModal(false)}\r\n                className=\"p-2 hover:bg-gray-100 rounded-lg\"\r\n              >\r\n                <X className=\"h-5 w-5 text-gray-500\" />\r\n              </button>\r\n            </div>\r\n\r\n            <form onSubmit={handleSubmit} className=\"p-6 space-y-4\">\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                  Organization\r\n                </label>\r\n                <input\r\n                  type=\"text\"\r\n                  value={organizationName}\r\n                  disabled\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-700\"\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                  Amount (₹)\r\n                </label>\r\n                <input\r\n                  type=\"number\"\r\n                  step=\"0.01\"\r\n                  min=\"0\"\r\n                  max={amountDue / 100}\r\n                  value={amount}\r\n                  onChange={(e) => setAmount(e.target.value)}\r\n                  required\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                />\r\n                <p className=\"text-xs text-gray-500 mt-1\">\r\n                  Amount due: ₹{(amountDue / 100).toFixed(2)}\r\n                </p>\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                  Notes (Optional)\r\n                </label>\r\n                <textarea\r\n                  value={notes}\r\n                  onChange={(e) => setNotes(e.target.value)}\r\n                  rows={3}\r\n                  placeholder=\"Payment reference, transaction ID, etc.\"\r\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                />\r\n              </div>\r\n\r\n              <div className=\"flex gap-3 pt-4\">\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setShowModal(false)}\r\n                  className=\"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors\"\r\n                >\r\n                  Cancel\r\n                </button>\r\n                <button\r\n                  type=\"submit\"\r\n                  disabled={loading}\r\n                  className=\"flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed\"\r\n                >\r\n                  {loading ? 'Recording...' : 'Record Payment'}\r\n                </button>\r\n              </div>\r\n            </form>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAAA;AACA;AAJA;;;;;AAYO,SAAS,oBAAoB,EAAE,SAAS,EAAE,SAAS,EAAE,gBAAgB,EAA4B;IACtG,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,iNAAQ,EAAC;IAC3C,MAAM,CAAC,QAAQ,UAAU,GAAG,IAAA,iNAAQ,EAAC,CAAC,YAAY,GAAG,EAAE,OAAO,CAAC;IAC/D,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,iNAAQ,EAAC;IACnC,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,iNAAQ,EAAC;IAEvC,MAAM,eAAe,OAAO;QAC1B,EAAE,cAAc;QAChB,WAAW;QAEX,IAAI;YACF,MAAM,cAAc,KAAK,KAAK,CAAC,WAAW,UAAU;YAEpD,MAAM,SAAS,MAAM,IAAA,oLAAmB,EAAC;gBACvC;gBACA;gBACA,OAAO,SAAS;YAClB;YAEA,IAAI,OAAO,OAAO,EAAE;gBAClB,MAAM;gBACN,aAAa;gBACb,OAAO,QAAQ,CAAC,MAAM;YACxB;QACF,EAAE,OAAO,OAAY;YACnB,MAAM,CAAC,OAAO,EAAE,MAAM,OAAO,EAAE;QACjC,SAAU;YACR,WAAW;QACb;IACF;IAEA,qBACE;;0BACE,8OAAC;gBACC,SAAS,IAAM,aAAa;gBAC5B,WAAU;gBACV,OAAM;0BAEN,cAAA,8OAAC,mOAAW;oBAAC,WAAU;;;;;;;;;;;YAGxB,2BACC,8OAAC;gBAAI,WAAU;0BACb,cAAA,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;4BAAI,WAAU;;8CACb,8OAAC;oCAAG,WAAU;8CAAsC;;;;;;8CACpD,8OAAC;oCACC,SAAS,IAAM,aAAa;oCAC5B,WAAU;8CAEV,cAAA,8OAAC,iMAAC;wCAAC,WAAU;;;;;;;;;;;;;;;;;sCAIjB,8OAAC;4BAAK,UAAU;4BAAc,WAAU;;8CACtC,8OAAC;;sDACC,8OAAC;4CAAM,WAAU;sDAA+C;;;;;;sDAGhE,8OAAC;4CACC,MAAK;4CACL,OAAO;4CACP,QAAQ;4CACR,WAAU;;;;;;;;;;;;8CAId,8OAAC;;sDACC,8OAAC;4CAAM,WAAU;sDAA+C;;;;;;sDAGhE,8OAAC;4CACC,MAAK;4CACL,MAAK;4CACL,KAAI;4CACJ,KAAK,YAAY;4CACjB,OAAO;4CACP,UAAU,CAAC,IAAM,UAAU,EAAE,MAAM,CAAC,KAAK;4CACzC,QAAQ;4CACR,WAAU;;;;;;sDAEZ,8OAAC;4CAAE,WAAU;;gDAA6B;gDAC1B,CAAC,YAAY,GAAG,EAAE,OAAO,CAAC;;;;;;;;;;;;;8CAI5C,8OAAC;;sDACC,8OAAC;4CAAM,WAAU;sDAA+C;;;;;;sDAGhE,8OAAC;4CACC,OAAO;4CACP,UAAU,CAAC,IAAM,SAAS,EAAE,MAAM,CAAC,KAAK;4CACxC,MAAM;4CACN,aAAY;4CACZ,WAAU;;;;;;;;;;;;8CAId,8OAAC;oCAAI,WAAU;;sDACb,8OAAC;4CACC,MAAK;4CACL,SAAS,IAAM,aAAa;4CAC5B,WAAU;sDACX;;;;;;sDAGD,8OAAC;4CACC,MAAK;4CACL,UAAU;4CACV,WAAU;sDAET,UAAU,iBAAiB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAS9C"}},
    {"offset": {"line": 499, "column": 0}, "map": {"version":3,"sources":["file:///E:/lyra-app-v3/src/components/PaymentSuccessBanner.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { CheckCircle2, X } from 'lucide-react';\r\nimport { useState, useEffect } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\n\r\nexport function PaymentSuccessBanner() {\r\n  const [show, setShow] = useState(true);\r\n  const router = useRouter();\r\n\r\n  useEffect(() => {\r\n    // Auto-hide after 10 seconds\r\n    const timer = setTimeout(() => {\r\n      handleClose();\r\n    }, 10000);\r\n\r\n    return () => clearTimeout(timer);\r\n  }, []);\r\n\r\n  const handleClose = () => {\r\n    setShow(false);\r\n    // Remove query parameter from URL\r\n    router.replace('/admin/billing');\r\n  };\r\n\r\n  if (!show) return null;\r\n\r\n  return (\r\n    <div className=\"fixed top-4 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-md\">\r\n      <div className=\"bg-green-50 border-2 border-green-200 rounded-lg shadow-lg p-4 mx-4\">\r\n        <div className=\"flex items-start gap-3\">\r\n          <div className=\"flex-shrink-0\">\r\n            <CheckCircle2 className=\"h-6 w-6 text-green-600\" />\r\n          </div>\r\n          <div className=\"flex-1\">\r\n            <h3 className=\"text-green-900 font-semibold mb-1\">Payment Successful!</h3>\r\n            <p className=\"text-green-700 text-sm\">\r\n              Your payment has been received and the invoice has been marked as paid. \r\n              Amount due is now ₹0.00.\r\n            </p>\r\n          </div>\r\n          <button\r\n            onClick={handleClose}\r\n            className=\"flex-shrink-0 text-green-600 hover:text-green-800\"\r\n          >\r\n            <X className=\"h-5 w-5\" />\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAEA;AAAA;AACA;AACA;AAJA;;;;;AAMO,SAAS;IACd,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,iNAAQ,EAAC;IACjC,MAAM,SAAS,IAAA,+IAAS;IAExB,IAAA,kNAAS,EAAC;QACR,6BAA6B;QAC7B,MAAM,QAAQ,WAAW;YACvB;QACF,GAAG;QAEH,OAAO,IAAM,aAAa;IAC5B,GAAG,EAAE;IAEL,MAAM,cAAc;QAClB,QAAQ;QACR,kCAAkC;QAClC,OAAO,OAAO,CAAC;IACjB;IAEA,IAAI,CAAC,MAAM,OAAO;IAElB,qBACE,8OAAC;QAAI,WAAU;kBACb,cAAA,8OAAC;YAAI,WAAU;sBACb,cAAA,8OAAC;gBAAI,WAAU;;kCACb,8OAAC;wBAAI,WAAU;kCACb,cAAA,8OAAC,qOAAY;4BAAC,WAAU;;;;;;;;;;;kCAE1B,8OAAC;wBAAI,WAAU;;0CACb,8OAAC;gCAAG,WAAU;0CAAoC;;;;;;0CAClD,8OAAC;gCAAE,WAAU;0CAAyB;;;;;;;;;;;;kCAKxC,8OAAC;wBACC,SAAS;wBACT,WAAU;kCAEV,cAAA,8OAAC,iMAAC;4BAAC,WAAU;;;;;;;;;;;;;;;;;;;;;;;;;;;AAMzB"}},
    {"offset": {"line": 611, "column": 0}, "map": {"version":3,"sources":["file:///E:/lyra-app-v3/src/components/ManualInvoiceGenerator.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { FileText, X } from 'lucide-react';\r\n\r\ninterface Organization {\r\n  id: string;\r\n  name: string;\r\n}\r\n\r\nexport function ManualInvoiceGenerator() {\r\n  const [isOpen, setIsOpen] = useState(false);\r\n  const [organizations, setOrganizations] = useState<Organization[]>([]);\r\n  const [selectedOrg, setSelectedOrg] = useState('');\r\n  const [periodStart, setPeriodStart] = useState('');\r\n  const [periodEnd, setPeriodEnd] = useState('');\r\n  const [loading, setLoading] = useState(false);\r\n  const [message, setMessage] = useState('');\r\n\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      fetchOrganizations();\r\n      \r\n      // Set default to current month\r\n      const now = new Date();\r\n      const start = new Date(now.getFullYear(), now.getMonth(), 1);\r\n      const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);\r\n      \r\n      setPeriodStart(start.toISOString().split('T')[0]);\r\n      setPeriodEnd(end.toISOString().split('T')[0]);\r\n    }\r\n  }, [isOpen]);\r\n\r\n  const fetchOrganizations = async () => {\r\n    try {\r\n      const response = await fetch('/api/billing/organizations');\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        setOrganizations(data.organizations || []);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching organizations:', error);\r\n    }\r\n  };\r\n\r\n  const handleGenerate = async () => {\r\n    if (!selectedOrg || !periodStart || !periodEnd) {\r\n      setMessage('Please fill in all fields');\r\n      return;\r\n    }\r\n\r\n    setLoading(true);\r\n    setMessage('');\r\n\r\n    try {\r\n      const response = await fetch('/api/billing/generate-invoice', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          organizationId: selectedOrg,\r\n          periodStart: new Date(periodStart).toISOString(),\r\n          periodEnd: new Date(periodEnd + 'T23:59:59').toISOString(),\r\n        }),\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (response.ok) {\r\n        setMessage(`✅ Invoice ${data.invoice.invoice_number} generated successfully!`);\r\n        setTimeout(() => {\r\n          setIsOpen(false);\r\n          window.location.reload();\r\n        }, 2000);\r\n      } else {\r\n        setMessage(`❌ ${data.error || 'Failed to generate invoice'}`);\r\n      }\r\n    } catch (error: any) {\r\n      setMessage(`❌ ${error.message || 'An error occurred'}`);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  if (!isOpen) {\r\n    return (\r\n      <button\r\n        onClick={() => setIsOpen(true)}\r\n        className=\"inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-700\"\r\n      >\r\n        <FileText size={16} />\r\n        Generate Manual Invoice\r\n      </button>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {/* Backdrop */}\r\n      <div \r\n        className=\"fixed inset-0 bg-black bg-opacity-50 z-40\"\r\n        onClick={() => setIsOpen(false)}\r\n      />\r\n\r\n      {/* Modal */}\r\n      <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4\">\r\n        <div className=\"bg-white rounded-xl shadow-xl max-w-md w-full p-6\">\r\n          <div className=\"flex items-center justify-between mb-6\">\r\n            <h2 className=\"text-xl font-bold text-gray-900\">Generate Invoice</h2>\r\n            <button\r\n              onClick={() => setIsOpen(false)}\r\n              className=\"text-gray-400 hover:text-gray-600\"\r\n            >\r\n              <X size={24} />\r\n            </button>\r\n          </div>\r\n\r\n          <div className=\"space-y-4\">\r\n            {/* Organization Select */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                Organization\r\n              </label>\r\n              <select\r\n                value={selectedOrg}\r\n                onChange={(e) => setSelectedOrg(e.target.value)}\r\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                disabled={loading}\r\n              >\r\n                <option value=\"\">Select organization...</option>\r\n                {organizations.map((org) => (\r\n                  <option key={org.id} value={org.id}>\r\n                    {org.name}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n\r\n            {/* Period Start */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                Period Start\r\n              </label>\r\n              <input\r\n                type=\"date\"\r\n                value={periodStart}\r\n                onChange={(e) => setPeriodStart(e.target.value)}\r\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                disabled={loading}\r\n              />\r\n            </div>\r\n\r\n            {/* Period End */}\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\r\n                Period End\r\n              </label>\r\n              <input\r\n                type=\"date\"\r\n                value={periodEnd}\r\n                onChange={(e) => setPeriodEnd(e.target.value)}\r\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\r\n                disabled={loading}\r\n              />\r\n            </div>\r\n\r\n            {/* Quick Select Buttons */}\r\n            <div className=\"flex gap-2\">\r\n              <button\r\n                onClick={() => {\r\n                  const now = new Date();\r\n                  const start = new Date(now.getFullYear(), now.getMonth(), 1);\r\n                  const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);\r\n                  setPeriodStart(start.toISOString().split('T')[0]);\r\n                  setPeriodEnd(end.toISOString().split('T')[0]);\r\n                }}\r\n                className=\"text-xs px-3 py-1.5 bg-blue-50 text-blue-700 rounded hover:bg-blue-100\"\r\n                disabled={loading}\r\n              >\r\n                This Month\r\n              </button>\r\n              <button\r\n                onClick={() => {\r\n                  const now = new Date();\r\n                  const start = new Date(now.getFullYear(), now.getMonth() - 1, 1);\r\n                  const end = new Date(now.getFullYear(), now.getMonth(), 0);\r\n                  setPeriodStart(start.toISOString().split('T')[0]);\r\n                  setPeriodEnd(end.toISOString().split('T')[0]);\r\n                }}\r\n                className=\"text-xs px-3 py-1.5 bg-gray-50 text-gray-700 rounded hover:bg-gray-100\"\r\n                disabled={loading}\r\n              >\r\n                Last Month\r\n              </button>\r\n            </div>\r\n\r\n            {/* Message */}\r\n            {message && (\r\n              <div className={`p-3 rounded-lg text-sm ${\r\n                message.startsWith('✅') \r\n                  ? 'bg-green-50 text-green-800' \r\n                  : 'bg-red-50 text-red-800'\r\n              }`}>\r\n                {message}\r\n              </div>\r\n            )}\r\n\r\n            {/* Actions */}\r\n            <div className=\"flex gap-3 pt-4\">\r\n              <button\r\n                onClick={handleGenerate}\r\n                disabled={loading || !selectedOrg || !periodStart || !periodEnd}\r\n                className=\"flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium\"\r\n              >\r\n                {loading ? 'Generating...' : 'Generate Invoice'}\r\n              </button>\r\n              <button\r\n                onClick={() => setIsOpen(false)}\r\n                disabled={loading}\r\n                className=\"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-700\"\r\n              >\r\n                Cancel\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 960, "column": 0}, "map": {"version":3,"sources":["file:///E:/lyra-app-v3/src/app/actions/organization-billing.ts"],"sourcesContent":["'use server';\r\n\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { createClient as createServiceClient } from '@supabase/supabase-js';\r\n\r\nconst serviceSupabase = createServiceClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n);\r\n\r\ninterface GenerateInvoiceParams {\r\n  organizationId: string;\r\n  periodStart: string;\r\n  periodEnd: string;\r\n}\r\n\r\ninterface SendInvoiceEmailParams {\r\n  invoiceId: string;\r\n}\r\n\r\ninterface RecordPaymentParams {\r\n  invoiceId: string;\r\n  amountPaisa: number;\r\n  razorpayOrderId?: string;\r\n  razorpayPaymentId?: string;\r\n  razorpaySignature?: string;\r\n  notes?: string;\r\n}\r\n\r\n/**\r\n * Generate invoice for an organization for a specific period\r\n */\r\nexport async function generateInvoice(params: GenerateInvoiceParams) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can generate invoices');\r\n  }\r\n\r\n  const { organizationId, periodStart, periodEnd } = params;\r\n\r\n  // Check if invoice already exists for this period\r\n  const { data: existing } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select('id')\r\n    .eq('organization_id', organizationId)\r\n    .eq('period_start', periodStart)\r\n    .eq('period_end', periodEnd)\r\n    .single();\r\n\r\n  if (existing) {\r\n    throw new Error('Invoice already exists for this period');\r\n  }\r\n\r\n  // Calculate amounts using the database function\r\n  const { data: amounts, error: calcError } = await serviceSupabase\r\n    .rpc('calculate_invoice_amounts', {\r\n      p_organization_id: organizationId,\r\n      p_period_start: periodStart,\r\n      p_period_end: periodEnd\r\n    });\r\n\r\n  if (calcError) throw calcError;\r\n\r\n  const totalAmount = amounts?.[0]?.total_amount_paisa || 0;\r\n  const totalTransactions = amounts?.[0]?.total_transactions || 0;\r\n\r\n  // Generate invoice number\r\n  const { data: invoiceNumber } = await serviceSupabase\r\n    .rpc('generate_invoice_number');\r\n\r\n  // Create invoice\r\n  const { data: invoice, error: insertError } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .insert({\r\n      organization_id: organizationId,\r\n      invoice_number: invoiceNumber,\r\n      period_start: periodStart,\r\n      period_end: periodEnd,\r\n      total_coin_transactions: totalTransactions,\r\n      total_amount_paisa: totalAmount,\r\n      amount_paid_paisa: 0,\r\n      amount_due_paisa: totalAmount,\r\n      status: totalAmount > 0 ? 'pending' : 'draft'\r\n    })\r\n    .select()\r\n    .single();\r\n\r\n  if (insertError) throw insertError;\r\n\r\n  return { success: true, invoice };\r\n}\r\n\r\n/**\r\n * Generate invoices for all organizations for the previous month\r\n */\r\nexport async function generateMonthlyInvoices() {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can generate invoices');\r\n  }\r\n\r\n  // Get all active organizations\r\n  const { data: organizations } = await serviceSupabase\r\n    .from('organizations')\r\n    .select('id, name');\r\n\r\n  if (!organizations) return { success: false, message: 'No organizations found' };\r\n\r\n  // Calculate previous month period\r\n  const now = new Date();\r\n  const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);\r\n  const periodStart = lastMonth.toISOString();\r\n  const periodEnd = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();\r\n\r\n  const results = [];\r\n\r\n  for (const org of organizations) {\r\n    try {\r\n      const result = await generateInvoice({\r\n        organizationId: org.id,\r\n        periodStart,\r\n        periodEnd\r\n      });\r\n      results.push({ organizationId: org.id, name: org.name, success: true, invoice: result.invoice });\r\n    } catch (error: any) {\r\n      results.push({ organizationId: org.id, name: org.name, success: false, error: error.message });\r\n    }\r\n  }\r\n\r\n  return { success: true, results };\r\n}\r\n\r\n/**\r\n * Send invoice email to organization\r\n */\r\nexport async function sendInvoiceEmail(params: SendInvoiceEmailParams) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can send invoice emails');\r\n  }\r\n\r\n  const { invoiceId } = params;\r\n\r\n  // Get invoice with organization details\r\n  const { data: invoice, error: fetchError } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select(`\r\n      *,\r\n      organizations (\r\n        id,\r\n        name,\r\n        contact_email\r\n      )\r\n    `)\r\n    .eq('id', invoiceId)\r\n    .single();\r\n\r\n  if (fetchError || !invoice) {\r\n    throw new Error('Invoice not found');\r\n  }\r\n\r\n  if (!invoice.organizations.contact_email) {\r\n    throw new Error('Organization does not have a contact email');\r\n  }\r\n\r\n  // Import email utilities\r\n  const { sendEmail, generateInvoiceEmailHTML } = await import('@/lib/email');\r\n  \r\n  // Generate email content\r\n  const appUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://lyra-app.co.in';\r\n  const invoiceUrl = `${appUrl}/admin/billing/${invoice.id}`;\r\n  const paymentUrl = `${appUrl}/admin/billing/${invoice.id}/pay`;\r\n  \r\n  const formatCurrency = (paisa: number) => {\r\n    return `₹${(paisa / 100).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\r\n  };\r\n\r\n  const formatDate = (date: string) => {\r\n    return new Date(date).toLocaleDateString('en-IN', {\r\n      day: '2-digit',\r\n      month: 'short',\r\n      year: 'numeric'\r\n    });\r\n  };\r\n\r\n  // Calculate due date: 30 days from invoice creation\r\n  const dueDate = new Date(invoice.created_at);\r\n  dueDate.setDate(dueDate.getDate() + 30);\r\n\r\n  const emailHTML = generateInvoiceEmailHTML({\r\n    invoiceNumber: invoice.invoice_number,\r\n    organizationName: invoice.organizations.name,\r\n    totalAmount: formatCurrency(invoice.total_amount_paisa),\r\n    dueDate: invoice.status === 'paid' && invoice.paid_at \r\n      ? `Paid on ${formatDate(invoice.paid_at)}`\r\n      : formatDate(dueDate.toISOString()),\r\n    invoiceUrl,\r\n    paymentUrl,\r\n    totalAmountPaisa: invoice.total_amount_paisa,\r\n  });\r\n\r\n  // Determine email subject based on amount\r\n  const emailSubject = invoice.total_amount_paisa === 0\r\n    ? `Monthly Statement ${invoice.invoice_number} - No Payment Required`\r\n    : `Invoice ${invoice.invoice_number} from Lyra Enterprises`;\r\n\r\n  // Send email\r\n  const result = await sendEmail({\r\n    to: invoice.organizations.contact_email,\r\n    subject: emailSubject,\r\n    html: emailHTML,\r\n  });\r\n\r\n  if (!result.success) {\r\n    throw new Error(`Failed to send email: ${result.error}`);\r\n  }\r\n\r\n  // Update invoice email tracking\r\n  await serviceSupabase\r\n    .from('organization_invoices')\r\n    .update({\r\n      email_sent: true,\r\n      email_sent_at: new Date().toISOString(),\r\n      reminder_count: (invoice.reminder_count || 0) + 1,\r\n      last_reminder_sent_at: new Date().toISOString()\r\n    })\r\n    .eq('id', invoiceId);\r\n\r\n  return { success: true, invoice, message: `Email sent to ${invoice.organizations.contact_email}` };\r\n}\r\n\r\n/**\r\n * Record a manual payment for an invoice\r\n */\r\nexport async function recordManualPayment(params: RecordPaymentParams) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can record payments');\r\n  }\r\n\r\n  const { invoiceId, amountPaisa, notes } = params;\r\n\r\n  // Get invoice\r\n  const { data: invoice, error: fetchError } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select('*, organizations(id)')\r\n    .eq('id', invoiceId)\r\n    .single();\r\n\r\n  if (fetchError || !invoice) {\r\n    throw new Error('Invoice not found');\r\n  }\r\n\r\n  // Create payment record\r\n  const { data: payment, error: paymentError } = await serviceSupabase\r\n    .from('organization_payments')\r\n    .insert({\r\n      invoice_id: invoiceId,\r\n      organization_id: invoice.organizations.id,\r\n      amount_paisa: amountPaisa,\r\n      payment_method: 'manual',\r\n      status: 'success',\r\n      notes: notes || 'Manual payment recorded by admin',\r\n      payment_date: new Date().toISOString()\r\n    })\r\n    .select()\r\n    .single();\r\n\r\n  if (paymentError) throw paymentError;\r\n\r\n  return { success: true, payment };\r\n}\r\n\r\n/**\r\n * Get all invoices with organization details\r\n */\r\nexport async function getAllInvoices() {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Unauthorized');\r\n  }\r\n\r\n  const { data: invoices, error } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select(`\r\n      *,\r\n      organizations (\r\n        id,\r\n        name,\r\n        email\r\n      )\r\n    `)\r\n    .order('created_at', { ascending: false });\r\n\r\n  if (error) throw error;\r\n\r\n  return { success: true, invoices };\r\n}\r\n\r\n/**\r\n * Get invoice details with payments\r\n */\r\nexport async function getInvoiceDetails(invoiceId: string) {\r\n  const supabase = await createClient();\r\n  \r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n\r\n  const { data: invoice, error } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .select(`\r\n      *,\r\n      organizations (\r\n        id,\r\n        name,\r\n        email\r\n      ),\r\n      organization_payments (\r\n        id,\r\n        amount_paisa,\r\n        payment_method,\r\n        status,\r\n        payment_date,\r\n        razorpay_payment_id,\r\n        notes\r\n      )\r\n    `)\r\n    .eq('id', invoiceId)\r\n    .single();\r\n\r\n  if (error) throw error;\r\n\r\n  return { success: true, invoice };\r\n}\r\n\r\n/**\r\n * Delete an invoice and all associated payments\r\n */\r\nexport async function deleteInvoice(invoiceId: string) {\r\n  const supabase = await createClient();\r\n  \r\n  // Check admin authorization\r\n  const { data: { user } } = await supabase.auth.getUser();\r\n  if (!user) throw new Error('Unauthorized');\r\n  \r\n  const { data: profile } = await serviceSupabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n    \r\n  if (profile?.role !== 'admin') {\r\n    throw new Error('Only admins can delete invoices');\r\n  }\r\n\r\n  // Delete invoice (cascade will delete associated payments)\r\n  const { error } = await serviceSupabase\r\n    .from('organization_invoices')\r\n    .delete()\r\n    .eq('id', invoiceId);\r\n\r\n  if (error) throw error;\r\n\r\n  // Revalidate the billing page to reflect changes\r\n  const { revalidatePath } = await import('next/cache');\r\n  revalidatePath('/admin/billing');\r\n\r\n  return { success: true, message: 'Invoice deleted successfully' };\r\n}\r\n"],"names":[],"mappings":";;;;;;;IAyYsB,gBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA"}},
    {"offset": {"line": 972, "column": 0}, "map": {"version":3,"sources":["file:///E:/lyra-app-v3/src/components/DeleteInvoiceButton.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { Trash2, AlertTriangle } from 'lucide-react';\r\nimport { deleteInvoice } from '@/app/actions/organization-billing';\r\nimport { useRouter } from 'next/navigation';\r\n\r\ninterface DeleteInvoiceButtonProps {\r\n  invoiceId: string;\r\n  invoiceNumber: string;\r\n  organizationName: string;\r\n}\r\n\r\nexport function DeleteInvoiceButton({ invoiceId, invoiceNumber, organizationName }: DeleteInvoiceButtonProps) {\r\n  const [showConfirm, setShowConfirm] = useState(false);\r\n  const [isDeleting, setIsDeleting] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const router = useRouter();\r\n\r\n  const handleDelete = async () => {\r\n    try {\r\n      setIsDeleting(true);\r\n      setError(null);\r\n      \r\n      await deleteInvoice(invoiceId);\r\n      \r\n      // Close modal\r\n      setShowConfirm(false);\r\n      setIsDeleting(false);\r\n      \r\n      // Refresh the current page to show updated data\r\n      router.refresh();\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : 'Failed to delete invoice');\r\n      setIsDeleting(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <button\r\n        onClick={() => setShowConfirm(true)}\r\n        className=\"inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-600 text-white text-xs font-medium rounded hover:bg-red-700 disabled:opacity-50\"\r\n        disabled={isDeleting}\r\n      >\r\n        <Trash2 className=\"h-3.5 w-3.5\" />\r\n        Delete\r\n      </button>\r\n\r\n      {/* Confirmation Modal */}\r\n      {showConfirm && (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\" onClick={() => setShowConfirm(false)}>\r\n          <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4\" onClick={(e) => e.stopPropagation()}>\r\n            <div className=\"p-6\">\r\n              <div className=\"flex items-start gap-4 mb-4\">\r\n                <div className=\"p-3 bg-red-100 rounded-full flex-shrink-0\">\r\n                  <AlertTriangle className=\"h-6 w-6 text-red-600\" />\r\n                </div>\r\n                <div className=\"flex-1 min-w-0\">\r\n                  <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">\r\n                    Delete Invoice?\r\n                  </h3>\r\n                  <p className=\"text-sm text-gray-600 mb-2\" style={{ wordBreak: 'break-word', overflowWrap: 'break-word' }}>\r\n                    Are you sure you want to delete invoice <strong>{invoiceNumber}</strong> for <strong>{organizationName}</strong>?\r\n                  </p>\r\n                  <p className=\"text-sm text-red-600 font-medium\" style={{ wordBreak: 'break-word', overflowWrap: 'break-word' }}>\r\n                    This action cannot be undone. All associated payment records will also be deleted.\r\n                  </p>\r\n                </div>\r\n              </div>\r\n\r\n              {error && (\r\n                <div className=\"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg\">\r\n                  <p className=\"text-sm text-red-600 break-words\">{error}</p>\r\n                </div>\r\n              )}\r\n\r\n              <div className=\"flex items-center justify-end gap-3 pt-2\">\r\n                <button\r\n                  onClick={() => {\r\n                    setShowConfirm(false);\r\n                    setError(null);\r\n                  }}\r\n                  className=\"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200\"\r\n                  disabled={isDeleting}\r\n                >\r\n                  Cancel\r\n                </button>\r\n                <button\r\n                  onClick={handleDelete}\r\n                  className=\"px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 disabled:opacity-50\"\r\n                  disabled={isDeleting}\r\n                >\r\n                  {isDeleting ? 'Deleting...' : 'Delete Invoice'}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAAA;AACA;AACA;AALA;;;;;;AAaO,SAAS,oBAAoB,EAAE,SAAS,EAAE,aAAa,EAAE,gBAAgB,EAA4B;IAC1G,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,iNAAQ,EAAC;IAC/C,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,iNAAQ,EAAC;IAC7C,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,iNAAQ,EAAgB;IAClD,MAAM,SAAS,IAAA,+IAAS;IAExB,MAAM,eAAe;QACnB,IAAI;YACF,cAAc;YACd,SAAS;YAET,MAAM,IAAA,8KAAa,EAAC;YAEpB,cAAc;YACd,eAAe;YACf,cAAc;YAEd,gDAAgD;YAChD,OAAO,OAAO;QAChB,EAAE,OAAO,KAAK;YACZ,SAAS,eAAe,QAAQ,IAAI,OAAO,GAAG;YAC9C,cAAc;QAChB;IACF;IAEA,qBACE;;0BACE,8OAAC;gBACC,SAAS,IAAM,eAAe;gBAC9B,WAAU;gBACV,UAAU;;kCAEV,8OAAC,oNAAM;wBAAC,WAAU;;;;;;oBAAgB;;;;;;;YAKnC,6BACC,8OAAC;gBAAI,WAAU;gBAAiF,SAAS,IAAM,eAAe;0BAC5H,cAAA,8OAAC;oBAAI,WAAU;oBAAuD,SAAS,CAAC,IAAM,EAAE,eAAe;8BACrG,cAAA,8OAAC;wBAAI,WAAU;;0CACb,8OAAC;gCAAI,WAAU;;kDACb,8OAAC;wCAAI,WAAU;kDACb,cAAA,8OAAC,yOAAa;4CAAC,WAAU;;;;;;;;;;;kDAE3B,8OAAC;wCAAI,WAAU;;0DACb,8OAAC;gDAAG,WAAU;0DAA2C;;;;;;0DAGzD,8OAAC;gDAAE,WAAU;gDAA6B,OAAO;oDAAE,WAAW;oDAAc,cAAc;gDAAa;;oDAAG;kEAChE,8OAAC;kEAAQ;;;;;;oDAAuB;kEAAK,8OAAC;kEAAQ;;;;;;oDAA0B;;;;;;;0DAElH,8OAAC;gDAAE,WAAU;gDAAmC,OAAO;oDAAE,WAAW;oDAAc,cAAc;gDAAa;0DAAG;;;;;;;;;;;;;;;;;;4BAMnH,uBACC,8OAAC;gCAAI,WAAU;0CACb,cAAA,8OAAC;oCAAE,WAAU;8CAAoC;;;;;;;;;;;0CAIrD,8OAAC;gCAAI,WAAU;;kDACb,8OAAC;wCACC,SAAS;4CACP,eAAe;4CACf,SAAS;wCACX;wCACA,WAAU;wCACV,UAAU;kDACX;;;;;;kDAGD,8OAAC;wCACC,SAAS;wCACT,WAAU;wCACV,UAAU;kDAET,aAAa,gBAAgB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAShD"}}]
}