{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///E:/lyra-app-v3/src/app/api/billing/verify-payment/route.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport crypto from 'crypto';\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const { razorpay_order_id, razorpay_payment_id, razorpay_signature } = await request.json();\r\n\r\n    // Verify signature\r\n    const body = razorpay_order_id + '|' + razorpay_payment_id;\r\n    const expectedSignature = crypto\r\n      .createHmac('sha256', process.env.RAZORPAY_KEY_SECRET!)\r\n      .update(body)\r\n      .digest('hex');\r\n\r\n    if (expectedSignature !== razorpay_signature) {\r\n      return NextResponse.json({ error: 'Invalid signature' }, { status: 400 });\r\n    }\r\n\r\n    const supabase = createClient(\r\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n      process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n    );\r\n\r\n    // Find invoice\r\n    const { data: invoice } = await supabase\r\n      .from('organization_invoices')\r\n      .select('id, organization_id, amount_due_paisa')\r\n      .eq('razorpay_order_id', razorpay_order_id)\r\n      .single();\r\n\r\n    if (!invoice) {\r\n      return NextResponse.json({ error: 'Invoice not found' }, { status: 404 });\r\n    }\r\n\r\n    // Check if payment already recorded\r\n    const { data: existingPayment } = await supabase\r\n      .from('organization_payments')\r\n      .select('id')\r\n      .eq('razorpay_payment_id', razorpay_payment_id)\r\n      .single();\r\n\r\n    if (!existingPayment) {\r\n      // Record payment\r\n      await supabase.from('organization_payments').insert({\r\n        invoice_id: invoice.id,\r\n        organization_id: invoice.organization_id,\r\n        amount_paisa: invoice.amount_due_paisa,\r\n        payment_method: 'razorpay',\r\n        razorpay_order_id,\r\n        razorpay_payment_id,\r\n        razorpay_signature,\r\n        status: 'success',\r\n        payment_date: new Date().toISOString(),\r\n        notes: 'Payment verified via frontend',\r\n      });\r\n\r\n      // Update invoice\r\n      await supabase\r\n        .from('organization_invoices')\r\n        .update({\r\n          razorpay_payment_id,\r\n          payment_method: 'razorpay',\r\n          paid_at: new Date().toISOString(),\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq('id', invoice.id);\r\n    }\r\n\r\n    return NextResponse.json({ success: true });\r\n  } catch (error: any) {\r\n    console.error('Verification error:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,EAAE,iBAAiB,EAAE,mBAAmB,EAAE,kBAAkB,EAAE,GAAG,MAAM,QAAQ,IAAI;QAEzF,mBAAmB;QACnB,MAAM,OAAO,oBAAoB,MAAM;QACvC,MAAM,oBAAoB,gHAAM,CAC7B,UAAU,CAAC,UAAU,QAAQ,GAAG,CAAC,mBAAmB,EACpD,MAAM,CAAC,MACP,MAAM,CAAC;QAEV,IAAI,sBAAsB,oBAAoB;YAC5C,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAoB,GAAG;gBAAE,QAAQ;YAAI;QACzE;QAEA,MAAM,WAAW,IAAA,yLAAY,gFAE3B,QAAQ,GAAG,CAAC,yBAAyB;QAGvC,eAAe;QACf,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAC7B,IAAI,CAAC,yBACL,MAAM,CAAC,yCACP,EAAE,CAAC,qBAAqB,mBACxB,MAAM;QAET,IAAI,CAAC,SAAS;YACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAoB,GAAG;gBAAE,QAAQ;YAAI;QACzE;QAEA,oCAAoC;QACpC,MAAM,EAAE,MAAM,eAAe,EAAE,GAAG,MAAM,SACrC,IAAI,CAAC,yBACL,MAAM,CAAC,MACP,EAAE,CAAC,uBAAuB,qBAC1B,MAAM;QAET,IAAI,CAAC,iBAAiB;YACpB,iBAAiB;YACjB,MAAM,SAAS,IAAI,CAAC,yBAAyB,MAAM,CAAC;gBAClD,YAAY,QAAQ,EAAE;gBACtB,iBAAiB,QAAQ,eAAe;gBACxC,cAAc,QAAQ,gBAAgB;gBACtC,gBAAgB;gBAChB;gBACA;gBACA;gBACA,QAAQ;gBACR,cAAc,IAAI,OAAO,WAAW;gBACpC,OAAO;YACT;YAEA,iBAAiB;YACjB,MAAM,SACH,IAAI,CAAC,yBACL,MAAM,CAAC;gBACN;gBACA,gBAAgB;gBAChB,SAAS,IAAI,OAAO,WAAW;gBAC/B,YAAY,IAAI,OAAO,WAAW;YACpC,GACC,EAAE,CAAC,MAAM,QAAQ,EAAE;QACxB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAC3C,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACnE;AACF"}}]
}