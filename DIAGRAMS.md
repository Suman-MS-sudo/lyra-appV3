# System Architecture Diagrams

## High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                          CLIENT LAYER                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │    Admin     │  │   Customer   │  │   Public     │          │
│  │  Dashboard   │  │    Portal    │  │   Pages      │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│         │                 │                  │                   │
└─────────┼─────────────────┼──────────────────┼───────────────────┘
          │                 │                  │
          └─────────────────┴──────────────────┘
                            │
          ┌─────────────────┴─────────────────┐
          │                                   │
┌─────────▼─────────────────────────────────────────────────────┐
│                     MIDDLEWARE LAYER                          │
├───────────────────────────────────────────────────────────────┤
│  • Authentication Check                                       │
│  • Route Protection                                           │
│  • Security Headers                                           │
│  • Session Management                                         │
└─────────┬─────────────────────────────────────────────────────┘
          │
          ├──────────────┬──────────────┬─────────────┐
          │              │              │             │
┌─────────▼────┐  ┌─────▼─────┐ ┌─────▼─────┐ ┌────▼────┐
│   Server     │  │    API    │ │  Server   │ │  Static │
│  Components  │  │   Routes  │ │  Actions  │ │  Assets │
└─────────┬────┘  └─────┬─────┘ └─────┬─────┘ └─────────┘
          │              │              │
          └──────────────┴──────────────┘
                        │
          ┌─────────────┴─────────────┐
          │                           │
┌─────────▼─────┐           ┌────────▼────────┐
│   Validation  │           │  Error Handling │
│  (Zod Schema) │           │   & Logging     │
└─────────┬─────┘           └────────┬────────┘
          │                           │
          └───────────┬───────────────┘
                      │
          ┌───────────▼────────────┐
          │   Supabase Client      │
          │  (Server/Client/MW)    │
          └───────────┬────────────┘
                      │
┌─────────────────────▼─────────────────────────────────────────┐
│                   DATABASE LAYER (PostgreSQL)                  │
├───────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌────────────┐      │
│  │Profiles │  │Machines │  │Products │  │Transactions│      │
│  └────┬────┘  └────┬────┘  └────┬────┘  └─────┬──────┘      │
│       │            │            │              │             │
│       └────────────┴────────────┴──────────────┘             │
│                        │                                      │
│                   ┌────▼─────┐                               │
│                   │   RLS    │  (Row Level Security)         │
│                   │ Policies │                               │
│                   └──────────┘                               │
└───────────────────────────────────────────────────────────────┘
```

## Authentication Flow

```
┌────────┐                                    ┌──────────┐
│ User   │                                    │ Supabase │
│ (Login)│                                    │   Auth   │
└───┬────┘                                    └────┬─────┘
    │                                              │
    │ 1. Submit credentials                        │
    ├─────────────────────────────────────────────►│
    │                                              │
    │                                   2. Validate│
    │                                   credentials│
    │                                              │
    │ 3. Return JWT token                          │
    │◄─────────────────────────────────────────────┤
    │                                              │
    │ 4. Store token in httpOnly cookie            │
    ├──────────────────────┐                       │
    │                      │                       │
    │◄─────────────────────┘                       │
    │                                              │
    │ 5. Redirect to dashboard                     │
    ├────────────┐                                 │
    │            │                                 │
┌───▼────────────▼───┐                             │
│ Protected Route    │                             │
│ (Admin/Customer)   │                             │
└───┬────────────────┘                             │
    │                                              │
    │ 6. Check auth via middleware                 │
    ├─────────────────────────────────────────────►│
    │                                              │
    │ 7. Validate JWT & get user                   │
    │◄─────────────────────────────────────────────┤
    │                                              │
    │ 8. Check RLS policies                        │
    ├──────────────┐                               │
    │              │                               │
    │◄─────────────┘                               │
    │                                              │
    │ 9. Render page                               │
    │                                              │
```

## Data Flow - Customer Purchase

```
┌─────────┐                                           ┌──────────┐
│Customer │                                           │ Database │
└────┬────┘                                           └────┬─────┘
     │                                                     │
     │ 1. Click "Purchase"                                │
     ├──────────────┐                                     │
     │              │                                     │
┌────▼──────────────▼───┐                                 │
│  Client Component     │                                 │
└────┬──────────────────┘                                 │
     │                                                     │
     │ 2. Call server action                              │
     │    createTransaction(formData)                     │
     ├────────────┐                                       │
     │            │                                       │
┌────▼────────────▼───────┐                               │
│   Server Action         │                               │
│  (src/app/actions/)     │                               │
└────┬────────────────────┘                               │
     │                                                     │
     │ 3. Validate with Zod                               │
     ├─────────────┐                                      │
     │             │                                      │
     │◄────────────┘                                      │
     │                                                     │
     │ 4. Check product availability                       │
     ├────────────────────────────────────────────────────►│
     │                                                     │
     │ 5. Return product & stock                           │
     │◄────────────────────────────────────────────────────┤
     │                                                     │
     │ 6. Validate stock >= quantity                       │
     ├────────┐                                            │
     │        │                                            │
     │◄───────┘                                            │
     │                                                     │
     │ 7. Create transaction (pending)                     │
     ├────────────────────────────────────────────────────►│
     │                                                     │
     │ 8. Return transaction ID                            │
     │◄────────────────────────────────────────────────────┤
     │                                                     │
     │ 9. Update product stock                             │
     ├────────────────────────────────────────────────────►│
     │                                                     │
     │ 10. Log inventory change (trigger)                  │
     │                                                     │
     │ 11. Update transaction to 'completed'               │
     ├────────────────────────────────────────────────────►│
     │                                                     │
     │ 12. Return success                                  │
     │◄────────────────────────────────────────────────────┤
     │                                                     │
     │ 13. Revalidate paths                                │
     ├─────────────┐                                       │
     │             │                                       │
     │◄────────────┘                                       │
     │                                                     │
     │ 14. Return to client                                │
     ├────────────┐                                        │
     │            │                                        │
┌────▼────────────▼──┐                                     │
│  Client Component  │                                     │
│  (Show success)    │                                     │
└────────────────────┘                                     │
```

## Supabase Three-Client Pattern

```
┌────────────────────────────────────────────────────────────┐
│                    APPLICATION CONTEXTS                     │
└────────────────────────────────────────────────────────────┘

┌──────────────────┐  ┌──────────────────┐  ┌──────────────┐
│ Client Component │  │ Server Component │  │  Middleware  │
│  ('use client')  │  │  (async default) │  │  (edge)      │
└────────┬─────────┘  └────────┬─────────┘  └──────┬───────┘
         │                     │                    │
         │                     │                    │
         │                     │                    │
┌────────▼─────────┐  ┌────────▼─────────┐  ┌──────▼───────┐
│  createClient()  │  │  createClient()  │  │updateSession()│
│  from            │  │  from            │  │  from         │
│  supabase/client │  │  supabase/server │  │supabase/middle│
└────────┬─────────┘  └────────┬─────────┘  └──────┬───────┘
         │                     │                    │
         │                     │                    │
┌────────▼─────────┐  ┌────────▼─────────┐  ┌──────▼───────┐
│ Browser Cookies  │  │ Server Cookies   │  │ Request      │
│ (document.cookie)│  │ (next/headers)   │  │ Cookies      │
└────────┬─────────┘  └────────┬─────────┘  └──────┬───────┘
         │                     │                    │
         └─────────────────────┴────────────────────┘
                               │
                    ┌──────────▼──────────┐
                    │   Supabase Auth     │
                    │   (Session Mgmt)    │
                    └─────────────────────┘
```

## RLS Policy Flow

```
┌────────────────────────────────────────────────────────────────┐
│              User makes database request                        │
└───────────────────────────┬────────────────────────────────────┘
                            │
                ┌───────────▼──────────┐
                │  Extract JWT from    │
                │  request headers     │
                └───────────┬──────────┘
                            │
                ┌───────────▼──────────┐
                │  Verify JWT          │
                │  signature           │
                └───────────┬──────────┘
                            │
                ┌───────────▼──────────┐
                │  Get user ID from    │
                │  auth.uid()          │
                └───────────┬──────────┘
                            │
                ┌───────────▼──────────┐
                │  Check user role     │
                │  from profiles table │
                └───────────┬──────────┘
                            │
                ┌───────────▼──────────┐
                │  Apply RLS policies  │
                │  for table & action  │
                └───────────┬──────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
┌───────▼──────┐   ┌────────▼────────┐   ┌─────▼────────┐
│   ALLOW      │   │   CHECK POLICY  │   │    DENY      │
│ (Admin role) │   │  (Own data?)    │   │(Unauthorized)│
└───────┬──────┘   └────────┬────────┘   └─────┬────────┘
        │                   │                   │
        │          ┌────────▼────────┐          │
        │          │  ALLOW if true  │          │
        │          │  DENY if false  │          │
        │          └────────┬────────┘          │
        │                   │                   │
        └───────────────────┴───────────────────┘
                            │
                ┌───────────▼──────────┐
                │  Execute query or    │
                │  return error        │
                └──────────────────────┘
```

## CI/CD Pipeline

```
┌─────────────────────────────────────────────────────────────┐
│                    Developer Workflow                        │
└─────────────────────────────────────────────────────────────┘

┌────────┐
│  Code  │
│ Change │
└───┬────┘
    │
    │ git push
    │
┌───▼───────────┐
│ GitHub Repo   │
└───┬───────────┘
    │
    │ Trigger
    │
┌───▼───────────────────────────────────────────────────────┐
│              GitHub Actions Workflow                      │
└───────────────────────────────────────────────────────────┘

    ┌──────────┐
    │   Lint   │
    │ (ESLint) │
    └────┬─────┘
         │ Pass
         │
    ┌────▼─────┐
    │   Test   │
    │ (Vitest) │
    └────┬─────┘
         │ Pass
         │
    ┌────▼─────┐
    │  Build   │
    │ (Next.js)│
    └────┬─────┘
         │ Pass
         │
    ┌────▼─────────────────────┐
    │  Branch Check            │
    └────┬────────────┬────────┘
         │            │
    develop          main
         │            │
    ┌────▼─────┐ ┌───▼────────┐
    │ Staging  │ │Production  │
    │ Deploy   │ │  Deploy    │
    └────┬─────┘ └───┬────────┘
         │            │
         ▼            ▼
    
    [Staging]    [Production]
     Vercel        Vercel
```

## Error Handling Flow

```
┌──────────────┐
│ Error Occurs │
└──────┬───────┘
       │
       ├─────────────────────┬─────────────────────┐
       │                     │                     │
┌──────▼───────┐   ┌─────────▼────────┐   ┌───────▼──────┐
│Server Action │   │  API Route       │   │  Component   │
│    Error     │   │  Error           │   │    Error     │
└──────┬───────┘   └─────────┬────────┘   └───────┬──────┘
       │                     │                     │
       │ throw AppError      │ throw AppError      │ throw Error
       │                     │                     │
┌──────▼───────────┐  ┌──────▼──────────┐  ┌──────▼─────────┐
│ Error Handler    │  │ API Handler     │  │ Error Boundary │
│ (try/catch)      │  │ (middleware)    │  │ (React)        │
└──────┬───────────┘  └──────┬──────────┘  └──────┬─────────┘
       │                     │                     │
       │ Log error           │ Log error           │ Log error
       │                     │                     │
┌──────▼───────────┐  ┌──────▼──────────┐  ┌──────▼─────────┐
│ logger.error()   │  │ logger.error()  │  │ logger.error() │
└──────┬───────────┘  └──────┬──────────┘  └──────┬─────────┘
       │                     │                     │
       │ Send to monitoring  │                     │
       │                     │                     │
┌──────▼───────────┐         │                     │
│ Analytics/Sentry │         │                     │
└──────────────────┘         │                     │
       │                     │                     │
       │ Return response     │ Return JSON         │ Show UI
       │                     │                     │
┌──────▼───────────┐  ┌──────▼──────────┐  ┌──────▼─────────┐
│ Redirect or      │  │ Error Response  │  │ Error UI       │
│ Error Response   │  │ (JSON)          │  │ Component      │
└──────────────────┘  └─────────────────┘  └────────────────┘
```

---

These diagrams represent the key architectural patterns in Lyra App v3. They can be used for:
- Onboarding new team members
- System documentation
- Architecture reviews
- Stakeholder presentations
